Backbone.pubSub=_.extend({},Backbone.Events);var originalRanks={},BarChartModel=Backbone.Model.extend({initialize:function(a){this.level=a.level,this.data=a.data,this.data_labels=a.data_labels,this.indicators=a.indicators,this.weighted=a.weighted,this.max=a.max,this.min=a.min,this.min_label=a.min_label,this.max_label=a.max_label,this.total_weighted=a.total_weighted}}),BarChartView=Backbone.View.extend({initialize:function(a){this.includeValueOnChart=a.includeValueOnChart,this.render()},render:function(){var a=this.model.data,b=this;if(a.forEach(function(c,d){var e=new BarChartItemModel({data:c,data_label:b.model.data_labels[d],holder:b.$el,level:b.model.level,numElements:a.length,trend:b.model.indicators[d],weighted:b.model.weighted[d],min:b.model.min,max:b.model.max,min_label:b.model.min_label,max_label:b.model.max_label,total_weighted:b.model.total_weighted}),f=new BarChartItemView({model:e,className:b.model.indicators[d]+"-bg",includeValue:b.includeValueOnChart});b.$el.append(f.$el),window.setTimeout(function(){f.$el.removeClass("initial-load")},200)}),1!=this.model.level&&2!=this.model.level){if(this.$el.append('<div class="indicator min"><span>'+this.model.min_label+"</span></div>"),this.model.min<0&&0!=this.model.max){var c=this.model.max-this.model.min,d=Math.abs(this.model.min)/c,e=100*d;this.$el.append('<div class="indicator zero" style="left:'+e+'%">0</div>')}this.$el.append('<div class="indicator max"><span>'+this.model.max_label+"</span></div>")}}}),BarChartItemModel=Backbone.Model.extend({initialize:function(a){this.data=a.data,this.data_label=a.data_label,this.holderWidth=a.holder.width(),this.numElements=a.numElements,this.trend=a.trend,this.weighted=a.weighted,this.min=a.min,this.max=a.max,this.min_label=a.min_label,this.max_label=a.max_label,this.total_weighted=a.total_weighted}}),BarChartItemView=Backbone.View.extend({initialize:function(a){this.includeValue=a.includeValue,this.render()},render:function(){var a=this.model.data,b=0;if(1==this.model.numElements){var c=this.model.max-this.model.min;if(this.model.min>0)var d=a-this.model.min;else var d=Math.abs(a);var e=d/c,f=100*e;if(this.model.min<0){var c=this.model.max-this.model.min,g=Math.abs(this.model.min)/c,h=100*g;b=0,a<0?f=h-f:f+=h}}else var i=this.model.max,j=this.model.weighted/i,f=100*j;if(this.$el.css({width:f+"%",left:b+"%"}),this.$el.data("value",a),this.$el.attr("data-weighted",this.model.weighted),this.$el.addClass("initial-load transition bar-segment"),this.includeValue)this.$el.append('<div class="value">'+this.model.data_label+"</div>");else if("undefined"!=typeof cgdCdi.indicators){var k=new BarChartTooltipModel({trend:cgdCdi.indicators[this.model.trend],value:this.model.data_label}),l=new BarChartTooltipView({model:k,className:"tooltip"});this.$el.append(l.$el)}}}),BarChartTooltipModel=Backbone.Model.extend({initialize:function(a){this.trend=a.trend,this.value=a.value}}),BarChartTooltipView=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.append('<span class="trend">'+this.model.trend+"</span><br/>"),this.$el.append('<span class="value">'+parseFloat(this.model.value).toFixed(1)+"</span>")}}),userWeights={CDI_AID:{value:1,unlocked:!0,invSTD:1.273950935},CDI_TRA:{value:1,unlocked:!0,invSTD:1.686829298},CDI_INV:{value:1,unlocked:!0,invSTD:1.961240567},CDI_MIG:{value:1,unlocked:!0,invSTD:1.589465703},CDI_ENV:{value:1,unlocked:!0,invSTD:1.516385285},CDI_SEC:{value:1,unlocked:!0,invSTD:.593957004},CDI_TEC:{value:1,unlocked:!0,invSTD:.944431458}},cdiApp=Backbone.View.extend({indicatorsOrder:["CDI_AID","CDI_INV","CDI_TEC","CDI_ENV","CDI_TRA","CDI_SEC","CDI_MIG"],indicatorColors:{CDI:{background:"#d4c7b5",border:"#574D40"},CDI_TEC:{background:"#F5EACF",border:"#ECBA42"},CDI_INV:{background:"#FFE8DA",border:"#C85A18"},CDI_AID:{background:"#FBE2E7",border:"#9E1421"},CDI_ENV:{background:"#E6FCF0",border:"#41B976"},CDI_TRA:{background:"#E9EDFF",border:"#21358B"},CDI_SEC:{background:"#DCF5FF",border:"#1792C5"},CDI_MIG:{background:"#F6E8FF",border:"#8850AC"}},initialize:function(a){Backbone.pubSub.on("userInput",this.userInput,this),Backbone.pubSub.on("adjustCDI",function(a){this.adjustCDI(a)},this),Backbone.pubSub.on("wasUnstacked",this.unstackBars,this);var b=this;$("#html5_wrapper").css("display","block"),$.get(a.url).done(function(c){b.data=c;var d=b.getCountryCodes();b.getCountryNames(d),b.getMainIndicators(),b.flattenData(),a.onLoad&&"function"==typeof b[a.onLoad]&&b[a.onLoad](a.args)})},userInput:function(a){if("resetWeight"===a){for(var b in userWeights)userWeights[b].value=1;var c=0;for(var b in userWeights)userWeights[b].totalWeight=userWeights[b].value*userWeights[b].invSTD;var d=this;return d.changeWeight(0,1,"click"),void dataLayer.push({event:"cdiResetWeight"})}eventType=a.type,transition=a.data.transition,"keyup"!==eventType?whichInd=this.indicatorsOrder[a.data.i]:whichInd=a.data.i,userWeights[whichInd].value=a.data.notch>=0?1+(this.changeFactor-1)*a.data.notch:1/(1+(this.changeFactor-1)*Math.abs(a.data.notch));var c=0;for(var b in userWeights)userWeights[b].totalWeight=userWeights[b].value*userWeights[b].invSTD,c+=1===userWeights[b].value?0:1;dataLayer.push({event:"cdiAdjustWeight",componentNotch:whichInd+"-"+a.data.notch}),this.changeWeight(c,transition,eventType)},flattenData:function(){function b(c){for(var d in c)a.flatIndicators[d]=JSON.parse(JSON.stringify(c[d])),c[d].children&&(b(c[d].children),"CDI"===d?a.flatIndicators[d].children=a.indicatorsOrder:a.flatIndicators[d].children=Object.keys(a.flatIndicators[d].children))}var a=this;this.flatIndicators={},b(this.data.indicators);for(var c in a.flatIndicators)c.indexOf("CDI")!=-1&&(a.flatIndicators[c].original=$.extend(!0,{},a.flatIndicators[c]));a.flatIndicators.CDI.previous=a.flatIndicators.CDI.previous?a.flatIndicators.CDI.previous:$.extend(!0,{},a.flatIndicators.CDI)},createBarChart:function(a,b,c,d,e,f,g,h,i,j){var k=[],l=[],m=this,n=[],o=isNaN(f)?0:f,p=isNaN(g)?0:g,h=h,i=i,q=0;c.forEach(function(a){var c=m.flatIndicators[a].values?m.flatIndicators[a].values[b]:0;k.push(c);var d=m.flatIndicators[a].user_friendly_values?m.flatIndicators[a].user_friendly_values[b]:"0";l.push(d);var e=m.flatIndicators[a].weighted?m.flatIndicators[a].weighted[b]:0;n.push(e),q+=e});var r=new BarChartModel({data:k,data_labels:l,weighted:n,level:j,min:o,max:p,min_label:h,max_label:i,total_weighted:q,indicators:c});new BarChartView({model:r,el:d,includeValueOnChart:e})},getCountryCodes:function(){var a=[];for(var b in this.data.indicators.CDI.values)this.data.indicators.CDI.values.hasOwnProperty(b)&&a.push(b);return a},getCountryNames:function(a){this.countries={AUS:"Australia",AUT:"Austria",BEL:"Belgium",CAN:"Canada",CHE:"Switzerland",CZE:"Czech Republic",DEU:"Germany",DNK:"Denmark",ESP:"Spain",FIN:"Finland",FRA:"France",GBR:"United Kingdom",GRC:"Greece",HUN:"Hungary",IRL:"Ireland",ITA:"Italy",JPN:"Japan",KOR:"South Korea",LUX:"Luxembourg",NLD:"Netherlands",NOR:"Norway",NZL:"New Zealand",POL:"Poland",PRT:"Portugal",SVK:"Slovakia",SWE:"Sweden",USA:"United States"}},sortScore:function(a,b,c,d){var e=this.flatIndicators[a];return e},getMainIndicators:function(){this.indicators={};var b=this.data.indicators.CDI.children;for(var c in b)b.hasOwnProperty(c)&&(this.indicators[c]=b[c].label)},reload:function(a,b){var c=a.toLowerCase()+"View";"CDI"===a?(this[c].show(a),$(".weight-toggle, .reset-weight").removeClass("weighted-override"),$(".reset-weight, .weights-instruct").attr("aria-hidden",!1),null!=b&&($mainRow=$("tr#"+b+"-master"),$("html, body").animate({scrollTop:$mainRow.offset().top-$("#main-menu").height()-$("#cdi-mainNav").height()-20},500))):this.loadIndicator(a,b)},hideIndicator:function(a){var a=a.toLowerCase(),b=("cdi"===a?"cdi":"indicator")+"View";this[b]&&this[b].hide()},getIndicatorsLabels:function(a){var b={},c=this;return a.forEach(function(a){b[a]=c.flatIndicators[a].label}),b},changeFactor:2,totalWeightsFn:function(){var a=0;for(var b in userWeights)a+=userWeights[b].totalWeight;return a},changeWeight:function(a,b,c){0===a?($(".reset-weight").attr("aria-hidden",!0),window.setTimeout(function(){$(".reset-weight").css("visibility","hidden")},400),$("#cdi-mainNav").removeClass("weighted-component"),$(".weights-component, .weights-instruct").attr("aria-hidden",!1)):($(".reset-weight").attr("aria-hidden",!1).css("visibility","visible"),$(".weights-component, .weights-instruct").attr("aria-hidden",!0)),sumTotalWeights=this.totalWeightsFn();for(var d in this.flatIndicators)if(d.indexOf("CDI_")!=-1)for(var e in this.flatIndicators[d].weighted)this.flatIndicators[d].weighted[e]=this.flatIndicators[d].original.values[e]*userWeights[d].totalWeight/sumTotalWeights;this.changeOverallScores(a,b,c)},changeOverallScores:function(a,b,c){this.flatIndicators.CDI.previous.values=$.extend(!0,{},this.flatIndicators.CDI.values);for(var d in this.flatIndicators.CDI.values){var e=0;for(var f in this.flatIndicators)f.indexOf("CDI_")!=-1&&(product=this.flatIndicators[f].values[d]*userWeights[f].totalWeight,e+=product);this.flatIndicators.CDI.values[d]=e/sumTotalWeights}Backbone.pubSub.trigger("rankCountries",[!0,a,b,c])},unstackBars:function(){var a=1,b=4,c=function(a){return Math.max.apply(null,a)};if(!this.maxes){this.maxes=[];for(var d in this.flatIndicators)d.indexOf("CDI_")!=-1&&this.maxes.push(this.flatIndicators[d].original.max);this.maxes.push(c(this.maxes))}for(var d in this.flatIndicators)if(d.indexOf("CDI_")!=-1)for(var e in this.flatIndicators[d].original.values){var f=$("tr#"+e+"-master div."+d+"-bg");f.addClass("transition"),f[0].hasAttribute("data-unweighted")||$(f).attr("data-unweighted",this.flatIndicators[d].original.values[e]);var g=(parseInt($(f).css("width"))/parseInt($(f).parent().css("width"))*100).toFixed(2)+"%";$(f).attr("data-stacked-width",g);var h=cgdCdi.indicatorsOrder.indexOf(d),i=$(f).attr("data-unweighted")/this.maxes[this.maxes.length-1]*(100/(7-b/10)-a)+"%";$(f).css({left:100*h/(7-b/10)+"%",position:"absolute",width:i});var j=$('<div class="zero-mark">');$(j).css("left",100*h/(7-b/10)+"%"),$("#"+e+"-master .chart-holder").append(j),$("#home-cdi").addClass("unstacked")}$(".slider, .reset-weight, .weights-instruct").addClass("hide-slider"),window.setTimeout(function(){$(".slider, .reset-weight").css("display","none"),$(".weights-instruct").css("visibility","hidden")},500),$(".reset-weight").attr("aria-hidden",!0),dataLayer.push({event:"Unstack"})},restackBars:function(){$(".reset-weight").css("display","inline").attr("aria-hidden",!1),$(".slider").css("display","block"),$(".bar-segment").each(function(){$(this).css({position:"relative",left:"0%",width:$(this).attr("data-stacked-width")})}),$("#home-cdi").removeClass("unstacked"),$(".weights-instruct").css("visibility","visible"),setTimeout(function(){$(".slider, .reset-weight, .weights-instruct").removeClass("hide-slider"),$(".weight-toggle, .reset-weight").removeClass("weighted-override")},200),dataLayer.push({event:"Restack"})},adjustCDI:function(a){if("resorted"===a[4])return void this.adjustScores(a);this.isUserWeighted=a[0];for(var b in this.flatIndicators)if(b.indexOf("CDI_")!=-1)for(var c in this.flatIndicators[b].weighted){var d=$("tr#"+c+"-master div."+b+"-bg");1===transition?d.addClass("transition"):d.removeClass("transition"),d.attr("data-weighted",this.flatIndicators[b].weighted[c]),newWidth=100*this.flatIndicators[b].weighted[c]/this.data.indicators.CDI.max,d.css("width",newWidth+"%")}"mousemove"!==a[4]&&"touchmove"!==a[4]&&this.adjustScores(a)},adjustScores:function(b){"resorted"===b[4],a=b[0],transition=b[1],ranksObj=b[2],originalRanksObj=b[3],0!==a?$(".original-rank").addClass("locked"):$(".original-rank").removeClass("locked"),$("tr.master-row").removeClass("processed"),that=this;for(var c in that.flatIndicators.CDI.values){var d=$("tr#"+c+"-master span.new-score"),e=$("tr#"+c+"-master span.original-score");e[0].innerHTML="("+that.flatIndicators.CDI.original.values[c].toFixed(2)+")",d[0].innerHTML=that.flatIndicators.CDI.values[c].toFixed(2)}window.setTimeout(function(){for(var b in ranksObj){parseFloat(that.flatIndicators.CDI.values[b].toFixed(2))>parseFloat(that.flatIndicators.CDI.original.values[b].toFixed(2))?$("tr#"+b+"-master").addClass("change-score better"):parseFloat(that.flatIndicators.CDI.values[b].toFixed(2))<parseFloat(that.flatIndicators.CDI.original.values[b].toFixed(2))?$("tr#"+b+"-master").addClass("change-score worse"):$("tr#"+b+"-master").removeClass("change-score worse better small-score-change medium-score-change large-score-change");var c=Math.abs(Math.round(10*(that.flatIndicators.CDI.values[b]-that.flatIndicators.CDI.original.values[b])))/10;c>=.4?$("tr#"+b+"-master").addClass("large-score-change"):c>=.2?$("tr#"+b+"-master").addClass("medium-score-change"):c>0&&$("tr#"+b+"-master").addClass("small-score-change");var d=$("tr#"+b+"-master span.new-rank");parseInt(ranksObj[b].rank_label)!==parseInt(originalRanksObj[b].rank_label)?($("tr#"+b+"-master").addClass("change-rank"),d[0].innerHTML=ranksObj[b].rank_label,rankDiff=Math.abs(parseInt(ranksObj[b].rank_label)-parseInt(originalRanksObj[b].rank_label)),rankDiff<=2?$("tr#"+b+"-master").addClass("small-rank-change"):rankDiff<=4?$("tr#"+b+"-master").addClass("medium-rank-change"):$("tr#"+b+"-master").addClass("large-rank-change")):d[0].innerHTML="",parseInt(ranksObj[b].rank_label)<parseInt(originalRanksObj[b].rank_label)?$("tr#"+b+"-master").addClass("better-rank"):parseInt(ranksObj[b].rank_label)>parseInt(originalRanksObj[b].rank_label)?$("tr#"+b+"-master").addClass("worse-rank"):$("tr#"+b+"-master").removeClass("worse-rank better-rank small-rank-change medium-rank-change large-rank-change")}for(var b in originalRanksObj){var e=$("tr#"+b+"-master span.original-rank");e[0].innerHTML=originalRanksObj[b].rank_label}0!==a&&$("tr.master-row").addClass("processed")},700)},startApp:function(){var a=new cdiApp.mainNav.Model({items:this.indicators});a.addOverallItem(),this.mainNavView=new cdiApp.mainNav.View({model:a,className:"mainNav",tagName:"div",id:"cdi-mainNav"}),$("#new_cdi .mainNav").remove(),$("#new_cdi").prepend(this.mainNavView.$el),$("#indicator-description-wrapper").addClass("idw-processed home").append('<a href="#" data-indicator="CDI_AID" class="cdi-next-button">Next up: aid</a>'),this.loadCDI()},events:{"click a.cdi-next-button":"triggerNext","click #unstack-td":"toggleStack"},toggleStack:function(){$(".unstack-slider").toggleClass("off"),$(".unstack-slider").hasClass("off")?this.unstackBars():this.restackBars()},triggerNext:function(a){a.preventDefault(),Backbone.pubSub.trigger("triggerNext",a)},loadCDI:function(a,b,c){function g(){$(e).eq(f).css({opacity:"0",position:"absolute"}),$(j).eq(f).removeClass("active-intro"),f=f+1<e.length?f+1:0,setTimeout(function(){$(e).eq(f).css({visibility:"visible",opacity:"1",position:"relative"}),$(j).eq(f).addClass("active-intro")},250),h()}function h(a){var b=0;for(i=0;i<e.length;i++)if(b=e[i].offsetHeight>b?e[i].offsetHeight:b,a===!0){var c=document.createElement("div");c.className="carousel-indicator-item",d.appendChild(c)}document.getElementById("cdi-carousel-wrapper").style.minHeight=b+"px"}var d=document.getElementById("carousel-indicator"),e=document.querySelectorAll(".cdi-carousel"),f=0;if(d){h(!0);var j=document.querySelectorAll(".carousel-indicator-item");j[0].className+=" active-intro";var k=document.createElement("button");k.id="intro-next",k.innerHTML="next",k.onclick=g;document.querySelector("#carousel-indicator-wrapper");document.querySelector("#carousel-indicator-wrapper").appendChild(k)}var m=new cdiApp.CDI.Model({indicator:this.flatIndicators.CDI,countries:this.countries,app:this});this.cdiView=new cdiApp.CDI.View({model:m,el:"#home-cdi"}),this.cdiView.render()},loadIndicator:function(a,b){$(".weight-toggle, .reset-weight").addClass("weighted-override"),$(".reset-weight, .weights-instruct").attr("aria-hidden",!0);var d=(a.toLowerCase(),this.sortScore(a,"score")),e=new cdiApp.CDI_Indicator.Model({data:d,countries:this.countries,indicator:a,app:this});this.indicatorView?(this.indicatorView.model=e,this.indicatorView.initialize()):this.indicatorView=new cdiApp.CDI_Indicator.View({model:e,el:"#home-cdi-indicator"}),this.indicatorView.render(),this.indicatorView.show(b)},loadCountry:function(a){var d,b=this,c="";a.countryCodes.forEach(function(e){c=".country-details."+e.toLowerCase(),d=a.comparison?$(".indicator.cdi "+c):$(c+" .indicator.cdi");var f=d.find(".indicator-rank");f.html("Rank: "+b.getRank(e,"CDI"));var g=d.find(".avg");g.html(b.flatIndicators.CDI.values[e].toFixed(2));for(var h in b.indicators){var i=[],j=h.toLowerCase();d=a.comparison?$(".indicator."+j+" "+c):$(c+" .indicator."+j);var k=d.find(".line-chart"),l=$("<canvas></canvas>");k.append(l);for(var m in b.flatIndicators[h].trends[e])i.push({year:m,data:b.flatIndicators[h].trends[e][m]});var n=new cdiApp.LineChart.Model({data:i,indicator:h}),o=new cdiApp.LineChart.View({model:n,el:l});k.append(o.$el);var f=d.find(".indicator-rank");f.html("Rank: "+b.getRank(e,h));var g=d.find(".avg");g.html(b.flatIndicators[h].values[e].toFixed(2));var p,q,r=[];k=d.find(".bar-charts");var s=b.flatIndicators[h].children;for(var t in s){var u=b.flatIndicators[s[t]];if(p=$('<div class="indicator-label category '+h+'">'+u.label+"</div>"),k.append(p),u.children)for(var v in u.children)p=$('<div class="indicator-label">'+b.flatIndicators[u.children[v]].label+' <a href="#info" class="indicator-info" data-indicator="'+u.children[v]+'">i</a></div>'),q=$('<div class="chart-holder"></div>'),k.append(p),k.append(q),r=[u.children[v]],all_data=b.flatIndicators[u.children[v]],null===all_data.values[e]&&q.addClass("null-value"),b.createBarChart(2016,e,r,q,!0,all_data.min,all_data.max,all_data.user_friendly_min,all_data.user_friendly_max,4);else p=$('<div class="indicator-label">'+u.label+' <a href="#info" class="indicator-info" data-indicator="'+s[t]+'">i</a></div>'),q=$('<div class="chart-holder"></div>'),r=[s[t]],k.append(p),k.append(q),all_data=b.flatIndicators[s[t]],b.createBarChart(2016,e,r,q,!0,all_data.min,all_data.max,all_data.user_friendly_min,all_data.user_friendly_max,3)}}}),$("a.indicator-info").click(function(a){a.preventDefault(),$target=$(a.target);var c=$target.data("indicator"),d=new cdiApp.Modal.Model({app:b,indicatorName:b.flatIndicators[c].label,indicatorDescription:b.flatIndicators[c].description});new cdiApp.Modal.View({model:d,className:"cdi-modal",tagName:"div"})})},getRank:function(a,b){var c=this.flatIndicators[b],d=0;for(var e in c.values)if(d++,e===a)break;return d},getTemplate:function(a){var b="";return $.ajax({url:Drupal.settings.basePath+Drupal.settings.cdi2016.pathToModule+"/templates/"+a+".tmpl.html",method:"GET",async:!1}).done(function(a){b=a}),b}});cdiApp.CDI={},cdiApp.CDI.Model=Backbone.Model.extend({initialize:function(a){Backbone.pubSub.on("rankCountries",function(a){this.rankCountries(a)},this),this.indicator=a.indicator,this.countries=a.countries,this.app=a.app,this.rankCountries([])},rankCountries:function(a){if(a[1]?this.isWeighted=a[1]:this.isWeighted=0,"mousemove"===a[3]||"touchmove"===a[3])return void Backbone.pubSub.trigger("adjustCDI",[a[1],a[2],this.ranksObj,this.originalRanksObj,a[3]]);this.groupedValues=[];var h,b=1,d=1,e=0,f=!1,g=0,k=[];for(var l in this.indicator.values){var m={};m.country=l,m.value=this.indicator.values[l],k.push(m)}for(k.sort(function(a,b){return b.value-a.value}),j=0;j<k.length;j++)if(i=k[j].country,this.indicator.user_friendly_values[i]=this.indicator.values[i].toFixed(2),this.indicator.values.hasOwnProperty(i)){currentTrimmed=parseFloat(this.indicator.values[i].toFixed(2)),currentTrimmed!=e?(b=d,e=currentTrimmed,f=!1):f=!0,d++,f&&(h.rank_label=g+"*");var n={rank:d,rank_label:b+(f?"*":""),country:this.countries[i],value:this.indicator.values[i],value_label:this.indicator.user_friendly_values[i],index:i};g=b,h=n,this.groupedValues.push(n)}for(this.ranksObj={},i=0;i<this.groupedValues.length;i++)c=this.groupedValues[i].index,this.ranksObj[c]=this.groupedValues[i];a[0]===!0?Backbone.pubSub.trigger("adjustCDI",[a[1],a[2],this.ranksObj,this.originalRanksObj,a[3]]):this.originalRanksObj=$.extend(!0,{},this.ranksObj)}}),cdiApp.CDI.View=Backbone.View.extend({initialize:function(){this.indicator=this.model.indicator,this.countries=this.model.countries,this.app=this.model.app,this.groupedValues=this.model.groupedValues,this.propName="",this.sortAsc=!0,"undefined"!=typeof FB&&FB.init({appId:"445215188878009"})},sortArray:function(a,b){null==a&&(a=!0);var c="country"===b?"country":"value";return"value"===c?function(b,d){return b[c]<d[c]?a?1:-1:b[c]>d[c]?a?-1:1:0}:function(b,d){return b[c]<d[c]?a?-1:1:b[c]>d[c]?a?1:-1:0}},render:function(a,b){this.collapsibleViews={};this.$el.find("tbody").html(""),this.groupedValues.sort(this.sortArray(a,b));for(var d in this.groupedValues)if(this.groupedValues.hasOwnProperty(d)){var e=this.groupedValues[d],f=new cdiApp.infoView({tagName:"tr",className:"info",id:e.index+"-info",countryCode:e.index}),g=new cdiApp.trendView({tagName:"tr",className:"trend",id:e.index+"-trend",countryCode:e.index,app:this.app});this.collapsibleViews[e.index]={info:f,trend:g};var i=($('<div class="chart-holder"></div>'),$('<tr tabindex="0" id="'+e.index+'-master" data-v="info" data-c="'+e.index+'" class="master-row"></tr>'));i.html('<td><span class="new-value new-rank"></span> <span class="original-value original-rank">'+e.rank_label+'</span></td><td><a class="expand-row" href="#" title="Expand row"><span class="country-label">'+e.country+'</span></a></td><td><div><span class="new-value new-score">'+e.value_label+'</span> <span class="original-value original-score"></span></td><td><div class="chart-holder"></div></td><td class="spacer"></td><td class="facebook-td"><a data-c="'+e.index+'" href="#"></a></td><td class="twitter-td"><a class="twitter-share-row" href="http://twitter.com/intent/tweet?text='+encodeURIComponent(e.country)+"%20ranks%20"+e.rank_label.replace("*","%20(tie)")+"%20of%2027%20on%20the%20Commitment%20to%20Development%20Index&amp;url="+encodeURIComponent(location.href)+'&amp;via=CGDev"></a></td>'),this.$el.find("tbody").append(i);var j=this.indicator.children;this.app.createBarChart(2016,e.index,j,i.find(".chart-holder"),!1,this.indicator.min,this.indicator.max,"0",this.indicator.user_friendly_max,1),this.$el.find("tbody").append(f.$el),this.$el.find("tbody").append(g.$el)}this.model.isWeighted&&Backbone.pubSub.trigger("adjustCDI",[1,0,this.model.ranksObj,this.model.originalRanksObj,"resorted"]),$("#home-cdi").addClass("home-processed")},events:{"mouseup .active .bar-segment":"barSegmentClicked","click tr.master-row, .load-trends, .close-info":"showCollapsed","click a.sorting":"sortColumn","click .facebook-td a":"facebookShare","click .twitter-td a":"twitterShare"},barSegmentClicked:function(a){a.preventDefault(),Backbone.pubSub.trigger("triggerNext",a),a.stopImmediatePropagation()},twitterShare:function(a){var b=a.currentTarget.parentNode.parentNode.getAttribute("data-c");dataLayer.push({event:"cdiTweet",label:b+"-overall"})},facebookShare:function(a){a.preventDefault(),a.stopImmediatePropagation();var b=this.model.originalRanksObj[$(a.target).attr("data-c")],c=b.country,d=b.rank_label.replace("*"," (tie)");FB.ui({method:"feed",name:c+" ranks "+d+" out of 27 on the Commitment to Development Index",caption:"The Commitment to Development Index: Ranking the Rich",description:"The Commitment to Development Index ranks 27 of the world's richest countries on their dedication to policies that benefit people living in poorer nations.",link:"http://www.cgdev.org"+location.pathname,picture:"http://www.cgdev.org/sites/default/files/cdi-2016-image-share_final.png"}),$(a.currentTarget).blur(),dataLayer.push({event:"cdiFacebook",label:c+"-overall"})},showCollapsed:function(a){if("twitter-share-row"!==a.target.className){a.preventDefault();var b=$(a.target),c=$(a.currentTarget);if(!b.hasClass("bar-segment")||!b.parent().parent().parent().hasClass("active")){var d=!!c.hasClass("close-bottom-trends"),e=c.attr("data-c"),f=c.attr("data-v");c=c.hasClass("close-info")?$("#"+e+"-master"):c.hasClass("close-component")?$("#home-cdi-indicator ."+e+"-master"):c;var g=this.collapsibleViews[e][f],h=0;if(c.hasClass("active")){if("info"===f){var i=$("#"+e+"-info a.load-trends");i.hasClass("active-trend")&&($targetInfo=c,c=i,viewInfo=g,g=this.collapsibleViews[e].trend,$("#"+e+"-trend .trends-wrapper").addClass("faster-collapse"),h=500,this.collapseTrends(c,g,h,e,d),c=$targetInfo,g=viewInfo),$("#"+e+"-info .info-wrapper").css("height",0),h=500,this.showCollapsedHelper(c,g,h,e)}"trend"===f&&($("#"+e+"-trend .trends-wrapper").css("height",0),h=750,this.collapseTrends(c,g,h,e))}else this.showCollapsedHelper(c,g,h,e)}}},collapseTrends:function(a,b,c,d,e){if($("#"+d+"-trend .trends-wrapper").css("height",0),this.showCollapsedHelper(a,b,c,d),e){var f=a.parent();$("html, body").animate({scrollTop:f.offset().top-$("#main-menu").height()-$("#cdi-mainNav").height()-$("tr#"+d+"-master").height()},500)}},showCollapsedHelper:function(a,b,c,d){window.setTimeout(function(){a.toggleClass("active").toggleClass("active-trend");var c=a.hasClass("active")?"open":"close";"info"===b.className&&dataLayer.push({event:"cdiToggleRow",rowAction:d+"-overall-"+c}),"trend"===b.className&&(dataLayer.push({event:"cdiToggleTrends",rowAction:d+"-"+c}),a.hasClass("active")?(a.addClass("fading"),setTimeout(function(){a.text("Hide trends"),a.removeClass("fading")},250)):(a.addClass("fading"),setTimeout(function(){a.text("Show trends"),a.removeClass("fading")},250))),b.toggle(),$("#"+d+"-trend .trends-wrapper").removeClass("faster-collapse")},c)},show:function(a){this.$el.show(),"CDI"===a&&setTimeout(function(){$("#home-cdi").addClass("home-processed")},200)},hide:function(){this.$el.hide()},sortColumn:function(a){a.preventDefault();var b=$(a.target);this.sortAsc=b.hasClass("asc");var c=b.data("field");$(".sorting").removeClass("asc des"),this.sortAsc?b.addClass("des"):b.addClass("asc"),this.sortAsc=!this.sortAsc,this.render(this.sortAsc,c),$("#unstack-td .unstack-slider").hasClass("off")&&Backbone.pubSub.trigger("wasUnstacked")}}),cdiApp.mainNav={},cdiApp.mainNav.Model=Backbone.Model.extend({initialize:function(a){var b=this,c=a.items;this.items=[];for(var d in cgdCdi.indicatorsOrder)cgdCdi.indicatorsOrder.hasOwnProperty(d)&&b.items.push({code:cgdCdi.indicatorsOrder[d],label:c[cgdCdi.indicatorsOrder[d]],active:!1})},addOverallItem:function(){this.items.unshift({code:"CDI",label:"Overall",active:!0})}}),cdiApp.mainNav.View=Backbone.View.extend({initialize:function(){Backbone.pubSub.on("triggerNext",function(a){this.menuItemClicked(a)},this),Backbone.pubSub.on("barSegClickContinued",function(a){this.menuItemClickedContinued(a)},this),this.render()},render:function(){var a=this.model.items,b=this;a.forEach(function(a,c){if(weightToggle=document.createElement("div"),weightToggle.setAttribute("data-indicator",a.code),weightToggle.className="weight-toggle "+a.code+"-bg "+(a.active?"active":""),activeIndicator=document.createElement("div"),activeIndicator.className="active-indicator",weightToggle.appendChild(activeIndicator),nameSpan=document.createElement("span"),nameSpan.innerHTML='<a class="'+(a.active?"active":"")+' selectable" href="#'+a.code+'" data-indicator="'+a.code+'">'+a.label+"</a>",weightToggle.appendChild(nameSpan),"CDI"!==a.code){for(sliderDiv=document.createElement("div"),sliderDiv.className="slider",i=0;i<7;i++)sliderNotch=document.createElement("div"),sliderNotch.className="slider-notches notch-"+i,sliderDiv.appendChild(sliderNotch);b.attachSliderEvents(sliderDiv,c),sliderSelector=document.createElement("button"),sliderSelector.setAttribute("aria-label",a.label+" weight adjuster"),sliderSelector.className="slider-selector",sliderSelectorInner=document.createElement("div"),sliderSelectorInner.className="slider-selector-inner",sliderSelector.appendChild(sliderSelectorInner),sliderDiv.appendChild(sliderSelector),b.attachSelectorEvents(sliderSelector,c),weightToggle.appendChild(sliderDiv)}else{var d=document.createElement("div");d.className="weights-instruct",$(d).attr("aria-hidden",!1),d.innerHTML='Sliders adjust <button aria-label="Move component weights to adjust scores" id="show-weights-note">weights</button>',weightToggle.appendChild(d);var e=document.createElement("div");e.className="reset-weight";var f=document.createElement("a");f.href="javascript:void(0);",$(e).attr("aria-hidden",!0),f.innerHTML="Reset weights",e.appendChild(f),weightToggle.appendChild(e)}b.$el.append(weightToggle)}),this.addMenuCloseButton(),this.addWeightsNote(),$(window).scroll(function(){el=document.getElementById("cdi-mainNav");var a=$("body").width()>739?31:$("body").width()>739?36:$("body").width()>539?58:35,b=$("#section-header").height()+$(".cdi-header-wrapper").height()+a;if($(document).scrollTop()>=b){var c=$("#cdi-mainNav").height()+20;$(el).addClass("stick-to-top"),$("#new_cdi").css("padding-top",c)}else $(el).removeClass("stick-to-top"),$("#new_cdi").css("padding-top","")})},addMenuCloseButton:function(){this.$el.append('<button id="close-mainNav">(X) Close</button>')},addWeightsNote:function(){this.$el.append('<div id="weights-note"><span>Custom weights X</span><div class="slider"><div class="notch-key notch-even notch-0">1/4</div><div class="notch-key notch-odd notch-1">1/3</div><div class="notch-key notch-even notch-2">1/2</div><div class="notch-key notch-odd notch-3">1</div><div class="notch-key notch-even notch-4">2</div><div class="notch-key notch-odd notch-5">3</div><div class="notch-key notch-even notch-6">4</div><div class="slider-notches even notch-0"></div><div class="slider-notches odd notch-1"></div><div class="slider-notches even notch-2"></div><div class="slider-notches odd notch-3"></div><div class="slider-notches even notch-4"></div><div class="slider-notches odd notch-5"></div><div class="slider-notches even notch-6"></div></div></div>')},attachSliderEvents:function(a,b){var c=this,d=b-1;$(a).click(function(a){sliderSelector=$(".slider .slider-selector").eq(d),sliderSelector.addClass("active-selector jump-selector"),sliderPosition=$(this).offset(),position=c.getXOffset(a),newPosition=position-sliderPosition.left-18,c.limitPosition(),a.data={},a.data.that=c,a.data.ev=a,a.data.i=d,c.selectorStop(a)})},attachSelectorEvents:function(a,b){var c=this,d=b-1;$(a).on("mousedown touchstart",null,d,function(a){a.stopPropagation(),a.preventDefault(),a.xStartOffset=c.getXOffset(a),a.startPosition=$(this).position(),c.selectorStart(a)}),$(a).on("keyup",null,d,function(a){c.keyedWeight(a)})},keyedWeight:function(a){37!==a.keyCode&&39!==a.keyCode||(37===a.keyCode?newPosition=a.currentTarget.offsetLeft-13.6666<-7?-8:parseFloat($(a.currentTarget).css("left"))-13.6666:39===a.keyCode&&(newPosition=a.currentTarget.offsetLeft+13.6666>73?74:parseFloat($(a.currentTarget).css("left"))+13.6666),$(a.currentTarget).css("left",Math.round(3*newPosition)/3),a.data={ev:{currentTarget:a.currentTarget},i:$(a.currentTarget).parent().parent().attr("data-indicator")},this.selectorStop(a))},selectorStart:function(a){sliderIndex=a.data,$(a.currentTarget).addClass("active-selector"),$("body").on("mousemove touchmove",null,{i:sliderIndex,ev:a,that:this},this.selectorMove),$("body").on("mouseup touchend",null,{i:sliderIndex,ev:a,that:this},this.selectorStop)},selectorMove:function(a){a.preventDefault(),xCurrentOffset=a.data.that.getXOffset(a),xDistance=xCurrentOffset-a.data.ev.xStartOffset,newPosition=a.data.ev.startPosition.left+xDistance,a.data.that.limitPosition(),sliderSelector=$(".slider .slider-selector").eq(a.data.i),sliderSelector.css("left",newPosition),a.data.notch=(newPosition+8)/13.6666-3,a.data.transition=0,Backbone.pubSub.trigger("userInput",a)},limitPosition:function(){newPosition<-8?newPosition=-8:newPosition>76&&(newPosition=76)},selectorStop:function(a){if("resetWeight"===a)return void window.setTimeout(function(){Backbone.pubSub.trigger("userInput",a);
},400);delay="slider"===a.data.ev.currentTarget.className?500:0,window.setTimeout(function(){$(".slider .slider-selector").removeClass("active-selector jump-selector")},delay),roundedPosition=13.6666*Math.round((newPosition+8)/13.6666),a.data.notch=Math.round((newPosition+8)/13.6666)-3;var b=a.data.ev.currentTarget;0!==a.data.notch?(eParent=$(b).parents(".weight-toggle"),$(eParent).addClass("weighted"),$(".reset-weight").css("display","inline"),window.setTimeout(function(){$("#cdi-mainNav").addClass("weighted-component")},400)):(eParent=$(b).parents(".weight-toggle"),$(eParent).removeClass("weighted"),$(".reset-weight").css("display","inline")),a.data.transition=1,"keyup"!==a.type&&(roundedPosition=roundedPosition<0?0:roundedPosition,sliderSelector.css("left",roundedPosition-8),$("body").off("mouseup touchend",a.data.that.selectorStop),$("body").off("mousemove touchmove",a.data.that.selectorMove)),window.setTimeout(function(){Backbone.pubSub.trigger("userInput",a)},400)},resetWeight:function(){$(".slider .slider-selector").addClass("jump-selector"),$(".slider .slider-selector").css("left","33px"),$(".weight-toggle").removeClass("weighted"),$("#cdi-mainNav").removeClass("weighted-component"),window.setTimeout(function(){$(".slider .slider-selector").removeClass("jump-selector")},400),$(".reset-weight").attr("aria-hidden",!0),e="resetWeight",this.selectorStop(e)},getXOffset:function(a){if("touchstart"===a.type||"touchmove"===a.type){var b=a.originalEvent.touches[0];return b.pageX}if("mousedown"===a.type||"mousemove"===a.type||"click"===a.type)return a.pageX},events:{"click a.selectable":"menuItemClicked","click .reset-weight a":"resetWeight","click #close-mainNav":"closeMainNav","mouseover #show-weights-note":"toggleWeightsNote","mouseout #show-weights-note":"toggleWeightsNote","click #show-weights-note":"toggleWeightsNote"},toggleWeightsNote:function(a){if("click"!==a.type||0===a.screenX)return"mouseout"===a.type?void this.hideWeightsNote():"mouseover"===a.type?void this.showWeightsNote():$("#weights-note").hasClass("show-note")?void this.hideWeightsNote():void this.showWeightsNote()},showWeightsNote:function(){$("#weights-note").css("visibility","visible"),$("#weights-note").addClass("show-note")},hideWeightsNote:function(){$("#weights-note").removeClass("show-note"),window.setTimeout(function(){$("#weights-note").css("visibility","hidden")},500)},closeMainNav:function(){var a=$("#cdi-mainNav").hasClass("closed")?"(X) Close":"Open menu";$("#cdi-mainNav").toggleClass("closed"),$("#close-mainNav").text(a),this.hideWeightsNote()},menuItemClickedContinued:function(a,b){that=this;var c=$(a.target),d=null;if(c.hasClass("cdi-next-button")&&(c=$("div."+c.attr("data-indicator")+"-bg a.selectable")),c.hasClass("bar-segment")&&(d=c.parent().parent().parent().attr("data-c"),c=$("div."+c[0].className.match(/CDI_\w{3}/)+"-bg a.selectable"),b="CDI"),c.hasClass("return-to-main")&&(d=c.attr("data-c"),returnMain=!0,c=$("div.CDI-bg a.selectable")),c.parent().parent().addClass("active"),this.toggleSliders(c.attr("data-indicator")),"CDI"===c.attr("data-indicator"))$("#indicator-description-wrapper").removeClass("idw-processed"),setTimeout(function(){$(".indicator-description, .indicator-explanation").empty(),cgdCdi.hideIndicator(b),cgdCdi.reload(c.attr("data-indicator"),d),$(".cdi-next-button").text("Next up: "+cgdCdi.indicators[cgdCdi.indicatorsOrder[0]]).attr("data-indicator","CDI_AID"),$("#indicator-description-wrapper").addClass("idw-processed home")},500);else{cgdCdi.hideIndicator(b),$("#indicator-description-wrapper").removeClass("home"),cgdCdi.reload(c.attr("data-indicator"),d);var e=cgdCdi.indicatorsOrder.indexOf(c.attr("data-indicator"));if($(".cdi-next-button").css("opacity",0),e<cgdCdi.indicatorsOrder.length-1){var f=e+1,g=cgdCdi.indicators[cgdCdi.indicatorsOrder[f]];setTimeout(function(){$(".cdi-next-button").text("Next up: "+g).attr("data-indicator",cgdCdi.indicatorsOrder[f]),$(".cdi-next-button").css("opacity",1)},500)}else setTimeout(function(){$(".cdi-next-button").text("Next up: Overall scores").attr("data-indicator","CDI"),$(".cdi-next-button").css("opacity",1)},500)}var h=$("body").width()>720?50:70,i=$("#section-header").height()+$(".cdi-header-wrapper").height()+h;$("#cdi-mainNav").hasClass("stick-to-top")&&null==d&&$("body").animate({scrollTop:i},200)},menuItemClicked:function(a){if(a.preventDefault(),!$(a.currentTarget).parent().parent().hasClass("active")){$(".show-return").removeClass("show-return");var b=this.$el.find("div.active");b.removeClass("active");var c=b.data("indicator");if("CDI"===c){if($("#indicator-description-wrapper").removeClass("idw-processed"),$("#home-cdi").removeClass("home-processed"),that=this,"mouseup"===a.type)return void setTimeout(function(){Backbone.pubSub.trigger("barSegClickContinued",a)},500);setTimeout(function(){that.menuItemClickedContinued(a,c)},500)}else this.menuItemClickedContinued(a,c)}},toggleSliders:function(a){"CDI"!==a?($(".slider").addClass("hide-slider"),window.setTimeout(function(){$(".slider").css("display","none")},500)):$(".unstack-slider").hasClass("off")||($(".slider").css("display","block"),window.setTimeout(function(){$(".slider").removeClass("hide-slider")},100))}}),cdiApp.collapsibleView=Backbone.View.extend({loaded:!1,toggle:function(a){this.$el.fadeToggle(0);var b=!!a;this.render(b)},hide:function(){this.$el.hide()},show:function(){this.loaded||this.render(),this.$el.show()}}),cdiApp.infoView=cdiApp.collapsibleView.extend({initialize:function(a){this.countryCode=a.countryCode},render:function(){that=this;var a=window.innerWidth<=410?42:81;if(this.loaded)cHeight=$("#"+that.countryCode+"-info .field-name-field-overall").height()+$("#"+that.countryCode+"-info .year-results").height()+a,$("#"+that.countryCode+"-info .info-wrapper").css("height",cHeight);else{this.loaded=!0;var b='<td colspan="7" class="info-td"><div class="info-wrapper"><div class="field field-name-field-overall field-type-text-long field-label-above"><div class="field-label">Overall:&nbsp;</div><div class="field-items"><div class="field-item even">'+cgdCdi.data.indicators.CDI.summaries[that.countryCode]+'</div></div></div><div class="year-results"><a class="cdi-country-report" href="/cdi-2016/country/'+that.countryCode+'" target="_blank">Country report</a></div><a data-c="'+that.countryCode+'" data-v="info" class="close-info active" href="#">(X) Close</a></div></td>';that.$el.append(b),cHeight=$("#"+that.countryCode+"-info .field-name-field-overall").height()+$("#"+that.countryCode+"-info .year-results").height()+a,$("#"+that.countryCode+"-info .year-results").before('<a class="load-trends" data-v="trend" data-c="'+that.countryCode+'" href="#">Show trends</a>'),$("#"+that.countryCode+"-info .info-wrapper").css("height",cHeight),$("#"+that.countryCode+"-info .year-results a").text("Country report").attr("target","_blank")}}}),cdiApp.trendView=cdiApp.collapsibleView.extend({initialize:function(a){this.countryCode=a.countryCode,this.app=a.app},render:function(){if(this.loaded){var g=$("#"+this.countryCode+"-trend .trends-inner-wrapper").height()+50;$("#"+this.countryCode+"-trend .trends-wrapper").css("height",g)}else{this.loaded=!0;var a=$('<div class="trends-inner-wrapper"></div>'),b=$('<div class="trends-wrapper"></div>'),c=$('<td colspan="7"></td>'),d=this;b.append(a),c.append(b),this.$el.append(c);var e=["CDI"].concat(this.app.indicatorsOrder);d.app.indicators.CDI="Overall",e.forEach(function(b){var c=[],e=$("<canvas></canvas>"),f=$('<div class="line-chart-wrapper '+b+'"></div>'),g=d.app.indicators[b],h=d.app.flatIndicators[b].values[d.countryCode];f.append('<div class="line-chart-header '+b+'"><span class="indicator-label">'+g+'</span> <span class="indicator-value">'+h.toFixed(1)+"</span></div>"),f.append(e),a.append(f);for(var i in d.app.flatIndicators[b].trends[d.countryCode])c.push({year:i,data:d.app.flatIndicators[b].trends[d.countryCode][i]});var j=new cdiApp.LineChart.Model({data:c,indicator:b});new cdiApp.LineChart.View({model:j,el:e})});var f=$('<div style="clear:left">');f.append('<div class="year-results hello"><a class="cdi-country-report" target="_blank" href="/cdi-2016/country/'+this.countryCode+'">Country report</a></div>'),a.append(f),a.append('<a data-c="'+this.countryCode+'" data-v="info" class="close-info close-bottom-trends active" href="#">(X) Close</a>');var g=$("#"+this.countryCode+"-trend .trends-inner-wrapper").height()+80;$("#"+this.countryCode+"-trend .trends-wrapper").css("height",g)}}}),cdiApp.LineChart={},cdiApp.LineChart.Model=Backbone.Model.extend({initialize:function(a){var b=cgdCdi.indicatorColors[a.indicator],c=b.border,d=b.background,e="rgba(0,0,0,.1)",f="#666";this.data={labels:[],datasets:[{data:[],fillColor:"rgba(0,0,0,0)",pointStrokeCol:c,strokeColor:c,pointColor:c}]};var g=this;a.data.forEach(function(a){g.data.labels.push(a.year),g.data.datasets[0].data.push(parseFloat(a.data).toFixed(2))}),this.options={scaleOverride:!0,scaleSteps:6,scaleStepWidth:2,scaleStartValue:0,scaleShowGridLines:!1,tooltipTemplate:"<%= value %>",tooltipFillColor:d,tooltipFontColor:"#706E69",tooltipXPadding:10,scaleLineColor:e,scaleFontColor:f,pointDotRadius:2,percentageInnerCutout:70,pointHitDetectionRadius:4}}}),cdiApp.LineChart.View=Backbone.View.extend({initialize:function(){this.data=this.model.data,this.options=this.model.options,this.render()},render:function(){var a=this.el.getContext("2d");new Chart(a).Line(this.data,this.options)}}),cdiApp.CDI_Indicator={},cdiApp.CDI_Indicator.Model=Backbone.Model.extend({initialize:function(a){this.app=a.app,this.data=a.data,this.indicator=a.indicator,this.indicators=this.app.flatIndicators[this.indicator].children,this.groupedValues=[];var b=1;for(var c in this.data.values)this.data.values.hasOwnProperty(c)&&(this.groupedValues.push({rank:b,country:this.app.countries[c],value:this.data.values[c],value_label:this.data.user_friendly_values[c],id:c,min:this.data.min,min_label:this.data.user_friendly_min,max:this.data.max,max_label:this.data.user_friendly_max}),b++)}}),cdiApp.CDI_Indicator.View=Backbone.View.extend({initialize:function(){this.data=this.model.data,this.indicator=this.model.indicator,this.app=this.model.app,this.indicators=this.model.indicators,this.groupedValues=this.model.groupedValues},render:function(){var a=this,b=this.indicators;this.$el.find("tbody").empty(),this.el.className=this.indicator,this.collapsibleViews={},$("#indicator-description-wrapper").removeClass("idw-processed");for(var d in this.groupedValues)if(this.groupedValues.hasOwnProperty(d)){var e=this.groupedValues[d],f=e.id,g=new cdiApp.Components.Model({countryCode:f,indicators:b,app:this.app}),h=new cdiApp.Components.View({tagName:"tr",className:"components "+f+"-components",model:g});this.collapsibleViews[f]={components:h};var j=($('<div class="chart-holder"></div>'),$('<tr class="'+f+'-master master-row" data-c="'+f+'"></tr>'));j.html("<td>"+e.rank+'</td><td><a href="#"><span class="country-label">'+e.country+"</a></span></td><td>"+e.value_label+'</td><td><div class="chart-holder"></div></td><td class="spacer"></td><td class="facebook-td"><a data-country="'+e.country+'" data-rank="'+e.rank+'" data-component="'+this.app.indicators[this.indicator]+'" href="#"></a></td><td class="twitter-td"><a class="twitter-share-row" href="http://twitter.com/intent/tweet?text='+e.country+"%20ranks%20"+e.rank+"%20of%2027%20on%20the%20"+this.app.indicators[this.indicator].toLowerCase()+"%20component%20of%20the%20Commitment%20to%20Development%20Index&amp;url="+encodeURIComponent(location.href)+'&amp;via=CGDev"></a></td>'),this.$el.find("tbody").append(j),this.app.createBarChart(2016,f,[this.indicator],j.find(".chart-holder"),!1,e.min,e.max,e.min_label,e.max_label,2),this.$el.find("tbody").append(h.$el),setTimeout(function(){$("#indicator-description").empty(),$("#indicator-description").append('<div class="indicator-description">'+a.model.data.description+"</div>"),$("#indicator-explanation").empty(),$("#indicator-explanation").append('<div class="indicator-description">'+a.model.data.explanation+"</div>"),$("#indicator-description-wrapper").addClass("idw-processed")},500)}},events:{"click tr.master-row, .close-components":"showComponents","click a.sorting":"sortColumn","click .facebook-td a":"facebookShare","click .twitter-td a":"twitterShare","click .return-to-main":"returnToMain"},returnToMain:function(a){a.preventDefault(),dataLayer.push({event:"cdiReturnMain",from:a.target.dataset.c+"-"+$("#home-cdi-indicator").attr("class")}),Backbone.pubSub.trigger("triggerNext",a)},twitterShare:function(a){var b=a.currentTarget.parentNode.parentNode.getAttribute("data-c");dataLayer.push({event:"cdiTweet",label:b+"-"+a.delegateTarget.className})},facebookShare:function(a){a.preventDefault(),a.stopImmediatePropagation(),FB.ui({method:"feed",name:a.currentTarget.dataset.country+" ranks "+a.currentTarget.dataset.rank+" out of 27 on "+a.currentTarget.dataset.component.toLowerCase()+" in the Commitment to Development Index",caption:"The Commitment to Development Index: Ranking the Rich",description:"The Commitment to Development Index ranks 27 of the world's richest countries on their dedication to policies that benefit people living in poorer nations.",link:"http://www.cgdev.org"+location.pathname,picture:"http://www.cgdev.org/sites/default/files/cdi-2016-image-share_final.png"}),dataLayer.push({event:"cdiFacebook",label:a.currentTarget.dataset.country+"-"+a.currentTarget.dataset.component.toLowerCase()}),$(a.currentTarget).blur()},showComponents:function(a){if(!a.target||"twitter-share-row"!==a.target.className){$target=$(a.currentTarget);var b=!!$target.hasClass("close-bottom"),c=$target.attr("data-c"),d=this.collapsibleViews[c].components;$target=$target.hasClass("close-components")?$("."+c+"-master"):$target,delay=0,$target.hasClass("active")&&($("."+c+"-components .components-wrapper").height(0),b&&this.scrollToTarget($target),delay=500);var e=$target.hasClass("active")?"close":"open",f=a.barSegment?"-direct":"";dataLayer.push({event:"cdiToggleRow",rowAction:c+"-"+$("#home-cdi-indicator").attr("class")+"-"+e+f}),setTimeout(function(){$target.toggleClass("active"),d.toggle(a.barSegment)},delay),a.barSegment?this.scrollToTarget($target,10):a.preventDefault()}},scrollToTarget:function(a,b){var c=null!=b?b:0;$("html, body").animate({scrollTop:a.offset().top-$("#main-menu").height()-$("#cdi-mainNav").height()-c},500)},show:function(a){if(this.$el.show(),null!=a){var b={};b.currentTarget=$("tr."+a+"-master.master-row"),b.barSegment=!0,this.showComponents(b)}},hide:function(){this.$el.hide()},sortColumn:function(a){a.preventDefault();var b=$(a.target),c=b.hasClass("asc"),d=b.data("field");c?b.removeClass("asc"):b.addClass("asc"),c=!c,this.sortByField(d,c)},sortByField:function(a,b){this.groupedValues.sort(this.sortArray(a,b)),this.render()},sortArray:function(a,b){return function(c,d){return c[a]<d[a]?b?-1:1:c[a]>d[a]?b?1:-1:0}}}),cdiApp.Components={},cdiApp.Components.Model=Backbone.Model.extend({initialize:function(a){this.app=a.app,this.countryCode=a.countryCode,this.data=this.app.getIndicatorsLabels(a.indicators)}}),cdiApp.Components.View=cdiApp.collapsibleView.extend({initialize:function(){this.countryCode=this.model.countryCode,this.indicator=this.model.indicator,this.data=this.model.data,this.app=this.model.app},render:function(a){if(!this.loaded){$(".show-return").removeClass("show-return"),this.loaded=!0;var b=$('<td colspan="7"></td>'),c=$('<div class="components-wrapper"></div>');a&&c.addClass("show-return");var d=$('<div class="components-inner-wrapper"></div>');c.append(d),b.append(c),this.$el.append(b),d.append('<div class="year-results"><a class="cdi-country-report" target="_blank" href="/cdi-2016/country/'+this.countryCode+'">Country report</a></div>','<a data-c="'+this.countryCode+'" data-v="components" class="close-components active" href="#">(X) Close</a>','<a data-c="'+this.countryCode+'" data-v="components" class="return-to-main active" href="#">(←) Go back</a>');for(var e in this.data){var f,g,h=[],i=this.app.flatIndicators[e];if(this.app.flatIndicators[e].children){f=$('<div class="indicator-label category '+this.app.flatIndicators[e].parent+'">'+this.data[e]+"</div>"),d.append(f);for(var j in this.app.flatIndicators[e].children)f=$('<div class="indicator-label">'+this.app.flatIndicators[this.app.flatIndicators[e].children[j]].label+' <a href="#info" class="indicator-info" data-indicator="'+this.app.flatIndicators[e].children[j]+'">i</a></div>'),g=$('<div class="chart-holder"></div>'),d.append(f),d.append(g),h=[this.app.flatIndicators[e].children[j]],i=this.app.flatIndicators[this.app.flatIndicators[e].children[j]],null===i.values[this.countryCode]&&g.addClass("null-value"),this.app.createBarChart(2016,this.countryCode,h,g,!0,i.min,i.max,i.user_friendly_min,i.user_friendly_max,4)}else{var f=$('<div class="indicator-label">'+this.data[e]+' <a href="#info" class="indicator-info" data-indicator="'+e+'">i</a></div>'),g=$('<div class="chart-holder"></div>');h=[e],d.append(f),d.append(g),this.app.createBarChart(2016,this.countryCode,h,g,!0,i.min,i.max,i.user_friendly_min,i.user_friendly_max,3)}}d.append('<div class="year-results"><a class="components-report-bottom cdi-country-report" target="_blank" href="/cdi-2016/country/'+this.countryCode+'">Country report</a></div>','<a data-c="'+this.countryCode+'" data-v="components" class="close-components close-bottom active" href="#">(X) Close</a>','<a data-c="'+this.countryCode+'" data-v="components" class="return-to-main close-bottom active" href="#">(←) Go back</a>')}var k=$("."+this.countryCode+"-components .components-inner-wrapper").height()+50;$("."+this.countryCode+"-components .components-wrapper").height(k)},events:{"click a.indicator-info":"showIndicatorInfo"},showIndicatorInfo:function(a){$target=$(a.target);var b=$target.data("indicator"),c=new cdiApp.Modal.Model({app:this.app,indicatorName:this.app.flatIndicators[b].label,indicatorDescription:this.app.flatIndicators[b].description});new cdiApp.Modal.View({model:c,className:"cdi-modal",tagName:"div"});a.preventDefault()}});