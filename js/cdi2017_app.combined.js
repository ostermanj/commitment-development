/* Revised and updated 2016/2017 by John Osterman http://ostermanj.io; original (2015) tool created by Creative Science http://creativesci.co/ */
Backbone.pubSub=_.extend({},Backbone.Events);var originalRanks={},currentYear=2017,BarChartModel=Backbone.Model.extend({initialize:function(e){this.level=e.level,this.data=e.data,this.data_labels=e.data_labels,this.indicators=e.indicators,this.weighted=e.weighted,this.max=e.max,this.min=e.min,this.min_label=e.min_label,this.max_label=e.max_label,this.total_weighted=e.total_weighted}}),BarChartView=Backbone.View.extend({initialize:function(e){this.includeValueOnChart=e.includeValueOnChart,this.render()},render:function(){var e=this.model.data,t=this;if(e.forEach(function(a,i){var n=new BarChartItemModel({data:a,data_label:t.model.data_labels[i],holder:t.$el,level:t.model.level,numElements:e.length,trend:t.model.indicators[i],weighted:t.model.weighted[i],min:t.model.min,max:t.model.max,min_label:t.model.min_label,max_label:t.model.max_label,total_weighted:t.model.total_weighted}),s=new BarChartItemView({model:n,className:t.model.indicators[i]+"-bg",includeValue:t.includeValueOnChart});t.$el.append(s.$el),window.setTimeout(function(){s.$el.removeClass("initial-load")},200)}),1!=this.model.level&&2!=this.model.level){if(this.$el.append('<div class="indicator min"><span>'+this.model.min_label+"</span></div>"),this.model.min<0&&0!=this.model.max){var a=this.model.max-this.model.min;Math.abs(this.model.min)}this.$el.append('<div class="indicator max"><span>'+this.model.max_label+"</span></div>")}}}),BarChartItemModel=Backbone.Model.extend({initialize:function(e){this.data=e.data,this.data_label=e.data_label,this.holderWidth=e.holder.width(),this.numElements=e.numElements,this.trend=e.trend,this.weighted=e.weighted,this.min=e.min,this.max=e.max,this.min_label=e.min_label,this.max_label=e.max_label,this.total_weighted=e.total_weighted}}),BarChartItemView=Backbone.View.extend({initialize:function(e){this.includeValue=e.includeValue,this.render()},render:function(){var e=this.model.data,t=0;if(1==this.model.numElements){i=this.model.max-this.model.min;if(this.model.min>0)a=e-this.model.min;else var a=Math.abs(e);r=100*(a/i);if(this.model.min<0){var i=this.model.max-this.model.min,n=100*(Math.abs(this.model.min)/i);t=0,e<0?r=n-r:r+=n}}else var s=this.model.max+.75,r=100*(this.model.weighted/s);if(this.$el.css({width:r+"%",left:t+"%"}),this.$el.data("value",e),this.$el.attr("data-weighted",this.model.weighted),this.$el.addClass("initial-load transition bar-segment"),this.includeValue)this.$el.append('<div class="value">'+this.model.data_label.replace(" ","&nbsp;")+"</div>");else if(void 0!==cgdCdi.indicators){var o=new BarChartTooltipModel({trend:cgdCdi.indicators[this.model.trend],value:this.model.data_label}),d=new BarChartTooltipView({model:o,className:"tooltip"});this.$el.append(d.$el)}}}),BarChartTooltipModel=Backbone.Model.extend({initialize:function(e){this.trend=e.trend,this.value=e.value}}),BarChartTooltipView=Backbone.View.extend({initialize:function(){this.render()},render:function(){this.$el.append('<span class="trend">'+this.model.trend+"</span><br/>"),this.$el.append('<span class="value">'+parseFloat(this.model.value).toFixed(1)+"</span>")}}),userWeights={CDI_AID:{value:1,unlocked:!0,invSTD:1.299973199},CDI_TRA:{value:1,unlocked:!0,invSTD:1.790527298},CDI_INV:{value:1,unlocked:!0,invSTD:1.983034042},CDI_MIG:{value:1,unlocked:!0,invSTD:1.599475172},CDI_ENV:{value:1,unlocked:!0,invSTD:1.988872233},CDI_SEC:{value:1,unlocked:!0,invSTD:1.717781332},CDI_TEC:{value:1,unlocked:!0,invSTD:1.449135814}},cdiApp=Backbone.View.extend({indicatorsOrder:["CDI_AID","CDI_INV","CDI_TEC","CDI_ENV","CDI_TRA","CDI_SEC","CDI_MIG"],indicatorColors:{CDI:{background:"#d4c7b5",border:"#574D40"},CDI_TEC:{background:"#F5EACF",border:"#ECBA42"},CDI_INV:{background:"#FFE8DA",border:"#C85A18"},CDI_AID:{background:"#FBE2E7",border:"#9E1421"},CDI_ENV:{background:"#E6FCF0",border:"#41B976"},CDI_TRA:{background:"#E9EDFF",border:"#21358B"},CDI_SEC:{background:"#DCF5FF",border:"#1792C5"},CDI_MIG:{background:"#F6E8FF",border:"#8850AC"}},initialize:function(e){Backbone.pubSub.on("userInput",this.userInput,this),Backbone.pubSub.on("adjustCDI",function(e){this.adjustCDI(e)},this),Backbone.pubSub.on("wasUnstacked",this.unstackBars,this);var t=this;$("#html5_wrapper").css("display","block"),$.get(e.url).done(function(a){t.data=a;var i=t.getCountryCodes();t.getCountryNames(i),t.getMainIndicators(),t.flattenData(),e.onLoad&&"function"==typeof t[e.onLoad]&&t[e.onLoad](e.args)})},userInput:function(e){if("resetWeight"===e){for(var t in userWeights)userWeights[t].value=1;a=0;for(var t in userWeights)userWeights[t].totalWeight=userWeights[t].value*userWeights[t].invSTD;return this.changeWeight(0,1,"click"),void dataLayer.push({event:"cdiResetWeight"})}eventType=e.type,transition=e.data.transition,"keyup"!==eventType?whichInd=this.indicatorsOrder[e.data.i]:whichInd=e.data.i,userWeights[whichInd].value=e.data.notch>=0?1+(this.changeFactor-1)*e.data.notch:1/(1+(this.changeFactor-1)*Math.abs(e.data.notch));var a=0;for(var t in userWeights)userWeights[t].totalWeight=userWeights[t].value*userWeights[t].invSTD,a+=1===userWeights[t].value?0:1;"click"!==eventType&&"touchend"!==eventType&&"keyup"!==eventType||dataLayer.push({event:"cdiAdjustWeight",componentNotch:whichInd+"-"+e.data.notch}),this.changeWeight(a,transition,eventType)},flattenData:function(){function e(a){for(var i in a)t.flatIndicators[i]=JSON.parse(JSON.stringify(a[i])),a[i].children&&(e(a[i].children),t.flatIndicators[i].children="CDI"===i?t.indicatorsOrder:Object.keys(t.flatIndicators[i].children))}var t=this;this.flatIndicators={},e(this.data.indicators);for(var a in t.flatIndicators)-1!=a.indexOf("CDI")&&(t.flatIndicators[a].original=$.extend(!0,{},t.flatIndicators[a]));t.flatIndicators.CDI.previous=t.flatIndicators.CDI.previous?t.flatIndicators.CDI.previous:$.extend(!0,{},t.flatIndicators.CDI)},createBarChart:function(e,t,a,i,n,s,r,o,d,l){var c=[],h=[],u=this,p=[],v=isNaN(s)?0:s,m=isNaN(r)?0:r,o=o,d=d,f=0;a.forEach(function(e){var a=u.flatIndicators[e].values?u.flatIndicators[e].values[t]:0;c.push(a);var i=u.flatIndicators[e].user_friendly_values?u.flatIndicators[e].user_friendly_values[t]:"0";h.push(i);var n=u.flatIndicators[e].weighted?u.flatIndicators[e].weighted[t]:0;p.push(n),f+=n});var g=new BarChartModel({data:c,data_labels:h,weighted:p,level:l,min:v,max:m,min_label:o,max_label:d,total_weighted:f,indicators:a});new BarChartView({model:g,el:i,includeValueOnChart:n})},addContext:function(e,t,a,i){var n=cgdCdi.flatIndicators[t[0]].max,s=cgdCdi.flatIndicators[t[0]].min,r=n-s,o=cgdCdi.flatIndicators[t[0]].values,d={};for(var l in o)if(o.hasOwnProperty(l)){var c=(o[l]-s)/r*100;d[c]=d[c]?d[c]+1:1;var h=$("<div>").addClass("context-div").css({left:"calc("+c+"% - 4px)"});a.append(h)}this.addMedianMarker(o,s,r,a),this.checkValueVisibility(o,s,r,a,i)},checkValueVisibility:function(e,t,a,i,n){(e[n]-t)/a*i.width()-9-i.children(".bar-segment").children("div.value").width()<0&&i.addClass("value-overset-left")},addMedianMarker:function(e,t,a,i){valuesArray=[];for(var n in e)e.hasOwnProperty(n)&&valuesArray.push(e[n]);numericalValues=valuesArray.map(function(e){if(!isNaN(+e))return+e});var s=(function(e){e.sort(function(e,t){return e-t});var t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(numericalValues)-t)/a*100,r=$("<div>").addClass("median-marker").css("left","calc("+s+"% - 1px)");i.append(r),(r.offset().left-20<i.children(".indicator.min").width()/2+i.children(".indicator.min").offset().left||r.offset().left+20>i.children(".indicator.max").offset().left)&&r.addClass("overlapped-median")},getCountryCodes:function(){var e=[];for(var t in this.data.indicators.CDI.values)this.data.indicators.CDI.values.hasOwnProperty(t)&&e.push(t);return e},getCountryNames:function(e){this.countries={AUS:"Australia",AUT:"Austria",BEL:"Belgium",CAN:"Canada",CHE:"Switzerland",CZE:"Czech Republic",DEU:"Germany",DNK:"Denmark",ESP:"Spain",FIN:"Finland",FRA:"France",GBR:"United Kingdom",GRC:"Greece",HUN:"Hungary",IRL:"Ireland",ITA:"Italy",JPN:"Japan",KOR:"South Korea",LUX:"Luxembourg",NLD:"Netherlands",NOR:"Norway",NZL:"New Zealand",POL:"Poland",PRT:"Portugal",SVK:"Slovak Republic",SWE:"Sweden",USA:"United States"}},sortScore:function(e,t,a,i){return this.flatIndicators[e]},getMainIndicators:function(){this.indicators={};var e=this.data.indicators.CDI.children;for(var t in e)e.hasOwnProperty(t)&&(this.indicators[t]=e[t].label)},reload:function(e,t){var a=e.toLowerCase()+"View";"CDI"===e?(this[a].show(e),$(".weight-toggle, .reset-weight").removeClass("weighted-override"),$(".reset-weight, .weights-instruct").attr("aria-hidden",!1),null!=t&&($mainRow=$("tr#"+t+"-master"),$("html, body").animate({scrollTop:$mainRow.offset().top-$("#main-menu").height()-$("#cdi-mainNav").height()-20},500))):this.loadIndicator(e,t)},hideIndicator:function(e){var t=("cdi"===(e=e.toLowerCase())?"cdi":"indicator")+"View";this[t]&&this[t].hide()},getIndicatorsLabels:function(e){var t={},a=this;return e.forEach(function(e){t[e]=a.flatIndicators[e].label}),t},changeFactor:2,totalWeightsFn:function(){var e=0;for(var t in userWeights)e+=userWeights[t].totalWeight;return e},changeWeight:function(e,t,a){0===e?($(".reset-weight").attr("aria-hidden",!0),window.setTimeout(function(){$(".reset-weight").css("visibility","hidden")},400),$("#cdi-mainNav").removeClass("weighted-component"),$(".weights-component, .weights-instruct").attr("aria-hidden",!1)):($(".reset-weight").attr("aria-hidden",!1).css("visibility","visible"),$(".weights-component, .weights-instruct").attr("aria-hidden",!0)),sumTotalWeights=this.totalWeightsFn();for(var i in this.flatIndicators)if(-1!=i.indexOf("CDI_"))for(var n in this.flatIndicators[i].weighted)this.flatIndicators[i].weighted[n]=this.flatIndicators[i].original.values[n]*userWeights[i].totalWeight/sumTotalWeights;this.changeOverallScores(e,t,a)},changeOverallScores:function(e,t,a){this.flatIndicators.CDI.previous.values=$.extend(!0,{},this.flatIndicators.CDI.values);for(var i in this.flatIndicators.CDI.values){var n=0;for(var s in this.flatIndicators)-1!=s.indexOf("CDI_")&&(product=this.flatIndicators[s].values[i]*userWeights[s].totalWeight,n+=product);this.flatIndicators.CDI.values[i]=n/sumTotalWeights}Backbone.pubSub.trigger("rankCountries",[!0,e,t,a])},unstackBars:function(){if(!this.maxes){this.maxes=[];for(var e in this.flatIndicators)-1!=e.indexOf("CDI_")&&this.maxes.push(this.flatIndicators[e].original.max);this.maxes.push(function(e){return Math.max.apply(null,e)}(this.maxes))}for(var e in this.flatIndicators)if(-1!=e.indexOf("CDI_"))for(var t in this.flatIndicators[e].original.values){var a=$("tr#"+t+"-master div."+e+"-bg");a.addClass("transition"),a[0].hasAttribute("data-unweighted")||$(a).attr("data-unweighted",this.flatIndicators[e].original.values[t]);var i=(parseInt($(a).css("width"))/parseInt($(a).parent().css("width"))*100).toFixed(2)+"%";$(a).attr("data-stacked-width",i);var n=cgdCdi.indicatorsOrder.indexOf(e),s=$(a).attr("data-unweighted")/this.maxes[this.maxes.length-1]*(100/6.6-1)+"%";$(a).css({left:100*n/6.6+"%",position:"absolute",width:s});var r=$('<div class="zero-mark">');$(r).css("left",100*n/6.6+"%"),$("#"+t+"-master .chart-holder").append(r),$("#home-cdi").addClass("unstacked")}$(".slider, .reset-weight, .weights-instruct").addClass("hide-slider"),window.setTimeout(function(){$(".slider, .reset-weight").css("display","none"),$(".weights-instruct").css("visibility","hidden")},500),$(".reset-weight").attr("aria-hidden",!0),dataLayer.push({event:"Unstack"})},restackBars:function(){$(".reset-weight").css("display","inline").attr("aria-hidden",!1),$(".slider").css("display","block"),$(".bar-segment").each(function(){$(this).css({position:"relative",left:"0%",width:$(this).attr("data-stacked-width")})}),$("#home-cdi").removeClass("unstacked"),$(".weights-instruct").css("visibility","visible"),setTimeout(function(){$(".slider, .reset-weight, .weights-instruct").removeClass("hide-slider"),$(".weight-toggle, .reset-weight").removeClass("weighted-override")},200),dataLayer.push({event:"Restack"})},adjustCDI:function(e){if("resorted"!==e[4]){this.isUserWeighted=e[0];for(var t in this.flatIndicators)if(-1!=t.indexOf("CDI_"))for(var a in this.flatIndicators[t].weighted){var i=$("tr#"+a+"-master div."+t+"-bg");1===transition?i.addClass("transition"):i.removeClass("transition"),i.attr("data-weighted",this.flatIndicators[t].weighted[a]),newWidth=100*this.flatIndicators[t].weighted[a]/(this.data.indicators.CDI.max+.75),i.css("width",newWidth+"%")}"mousemove"!==e[4]&&"touchmove"!==e[4]&&this.adjustScores(e)}else this.adjustScores(e)},adjustScores:function(e){e[4],a=e[0],transition=e[1],ranksObj=e[2],originalRanksObj=e[3],0!==a?$(".original-rank").addClass("locked"):$(".original-rank").removeClass("locked"),$("tr.master-row").removeClass("processed"),that=this;for(var t in that.flatIndicators.CDI.values){var i=$("tr#"+t+"-master span.new-score");$("tr#"+t+"-master span.original-score")[0].innerHTML="("+that.flatIndicators.CDI.original.values[t].toFixed(2)+")",i[0].innerHTML=that.flatIndicators.CDI.values[t].toFixed(2)}window.setTimeout(function(){for(var e in ranksObj){parseFloat(that.flatIndicators.CDI.values[e].toFixed(2))>parseFloat(that.flatIndicators.CDI.original.values[e].toFixed(2))?$("tr#"+e+"-master").addClass("change-score better"):parseFloat(that.flatIndicators.CDI.values[e].toFixed(2))<parseFloat(that.flatIndicators.CDI.original.values[e].toFixed(2))?$("tr#"+e+"-master").addClass("change-score worse"):$("tr#"+e+"-master").removeClass("change-score worse better small-score-change medium-score-change large-score-change");var t=Math.abs(Math.round(10*(that.flatIndicators.CDI.values[e]-that.flatIndicators.CDI.original.values[e])))/10;t>=.4?$("tr#"+e+"-master").addClass("large-score-change"):t>=.2?$("tr#"+e+"-master").addClass("medium-score-change"):t>0&&$("tr#"+e+"-master").addClass("small-score-change");var i=$("tr#"+e+"-master span.new-rank");parseInt(ranksObj[e].rank_label)!==parseInt(originalRanksObj[e].rank_label)?($("tr#"+e+"-master").addClass("change-rank"),i[0].innerHTML=ranksObj[e].rank_label,rankDiff=Math.abs(parseInt(ranksObj[e].rank_label)-parseInt(originalRanksObj[e].rank_label)),rankDiff<=2?$("tr#"+e+"-master").addClass("small-rank-change"):rankDiff<=4?$("tr#"+e+"-master").addClass("medium-rank-change"):$("tr#"+e+"-master").addClass("large-rank-change")):i[0].innerHTML="",parseInt(ranksObj[e].rank_label)<parseInt(originalRanksObj[e].rank_label)?$("tr#"+e+"-master").addClass("better-rank"):parseInt(ranksObj[e].rank_label)>parseInt(originalRanksObj[e].rank_label)?$("tr#"+e+"-master").addClass("worse-rank"):$("tr#"+e+"-master").removeClass("worse-rank better-rank small-rank-change medium-rank-change large-rank-change")}for(var e in originalRanksObj)$("tr#"+e+"-master span.original-rank")[0].innerHTML=originalRanksObj[e].rank_label;0!==a&&$("tr.master-row").addClass("processed")},700)},startApp:function(){var e=new cdiApp.mainNav.Model({items:this.indicators});e.addOverallItem(),this.mainNavView=new cdiApp.mainNav.View({model:e,className:"mainNav",tagName:"div",id:"cdi-mainNav"}),$("#new_cdi .mainNav").remove(),$("#new_cdi").prepend(this.mainNavView.$el),$("#indicator-description-wrapper").addClass("idw-processed home").append('<a href="#" data-indicator="CDI_AID" class="cdi-next-button">Next up: aid</a>'),this.loadCDI()},events:{"click a.cdi-next-button":"triggerNext","click #unstack-td":"toggleStack"},toggleStack:function(){$(".unstack-slider").toggleClass("off"),$(".unstack-slider").hasClass("off")?this.unstackBars():this.restackBars()},triggerNext:function(e){e.preventDefault(),Backbone.pubSub.trigger("triggerNext",e)},loadCDI:function(e,t,a){function n(e){var t=0;for(i=0;i<r.length;i++)if(t=r[i].offsetHeight>t?r[i].offsetHeight:t,!0===e){var a=document.createElement("div");a.className="carousel-indicator-item",s.appendChild(a)}document.getElementById("cdi-carousel-wrapper").style.minHeight=t+"px"}var s=document.getElementById("carousel-indicator"),r=document.querySelectorAll(".cdi-carousel"),o=0;if(s){n(!0);var d=document.querySelectorAll(".carousel-indicator-item");d[0].className+=" active-intro";var l=document.createElement("button");l.id="intro-next",l.innerHTML="next",l.onclick=function(){$(r).eq(o).css({opacity:"0",position:"absolute"}),$(d).eq(o).removeClass("active-intro"),o=o+1<r.length?o+1:0,setTimeout(function(){$(r).eq(o).css({visibility:"visible",opacity:"1",position:"relative"}),$(d).eq(o).addClass("active-intro")},250),n()};document.querySelector("#carousel-indicator-wrapper");document.querySelector("#carousel-indicator-wrapper").appendChild(l)}var c=new cdiApp.CDI.Model({indicator:this.flatIndicators.CDI,countries:this.countries,app:this});this.cdiView=new cdiApp.CDI.View({model:c,el:"#home-cdi"}),this.cdiView.render()},loadIndicator:function(e,t){$(".weight-toggle, .reset-weight").addClass("weighted-override"),$(".reset-weight, .weights-instruct").attr("aria-hidden",!0);e.toLowerCase();var a=this.sortScore(e,"score"),i=new cdiApp.CDI_Indicator.Model({data:a,countries:this.countries,indicator:e,app:this});this.indicatorView?(this.indicatorView.model=i,this.indicatorView.initialize()):this.indicatorView=new cdiApp.CDI_Indicator.View({model:i,el:"#home-cdi-indicator"}),this.indicatorView.render(),this.indicatorView.show(t)},loadCountry:function(e){var t=this;if(void 0!=originalRanks[e.countryCodes[0]]){var a=0;for(var i in t.countries)t.countries.hasOwnProperty(i)&&a++;var n,s="";e.countryCodes.forEach(function(i){s=".country-details."+i.toLowerCase();var r=(n=e.comparison?$(".indicator.cdi "+s):$(s+" .indicator.cdi")).find(".indicator-rank");r.html("Rank: "+t.getRank(i,"CDI")+" / "+a);var o=n.find(".avg");o.html(t.flatIndicators.CDI.values[i].toFixed(2));for(var d in t.indicators){var l=[],c=d.toLowerCase(),h=(n=e.comparison?$(".indicator."+c+" "+s):$(s+" .indicator."+c)).find(".line-chart"),u=$("<canvas></canvas>");h.append(u);for(var p in t.flatIndicators[d].trends[i])l.push({year:p,data:t.flatIndicators[d].trends[i][p]});var v=new cdiApp.LineChart.Model({data:l,indicator:d}),m=new cdiApp.LineChart.View({model:v,el:u});h.append(m.$el),(r=n.find(".indicator-rank")).html("Rank: "+t.getRank(i,d)+" / "+a),(o=n.find(".avg")).html(t.flatIndicators[d].values[i].toFixed(2));var f,g,C=[];h=n.find(".bar-charts");var w=t.flatIndicators[d].children;for(var b in w){var I=t.flatIndicators[w[b]];if(I.children){f=$('<div class="indicator-label category '+d+'">'+I.label+"</div>"),h.append(f);for(var y in I.children){k=null!==t.flatIndicators[I.children[y]].unit?t.flatIndicators[I.children[y]].unit:"",f=$('<div class="indicator-label">'+t.flatIndicators[I.children[y]].label+' <a href="#info" class="indicator-info" data-indicator="'+I.children[y]+'">?</a><br /><span class="indicator-units">'+k+"</span></div>"),g=$('<div class="chart-holder"></div>'),h.append(f),h.append(g),C=[I.children[y]],all_data=t.flatIndicators[I.children[y]],isNaN(all_data.user_friendly_values[i].replace(/%|\$/,""))&&g.addClass("null-value"),all_data.less_is_better&&g.addClass("less-is-better"),t.createBarChart(currentYear,i,C,g,!0,all_data.min,all_data.max,all_data.user_friendly_min,all_data.user_friendly_max,4),t.addContext(currentYear,C,g,i)}}else{var k;k=null!==I.unit?I.unit:"",f=$('<div class="indicator-label no-child category '+d+'">'+I.label+' <a href="#info" class="indicator-info" data-indicator="'+w[b]+'">?</a><br /><span class="indicator-units">'+k+"</span></div>"),g=$('<div class="chart-holder"></div>'),C=[w[b]],h.append(f),h.append(g),all_data=t.flatIndicators[w[b]],isNaN(all_data.user_friendly_values[i].replace(/%|\$/,""))&&g.addClass("null-value"),all_data.less_is_better&&g.addClass("less-is-better"),t.createBarChart(currentYear,i,C,g,!0,all_data.min,all_data.max,all_data.user_friendly_min,all_data.user_friendly_max,3),t.addContext(currentYear,C,g,i)}}}}),$("a.indicator-info").click(function(e){e.preventDefault(),$target=$(e.target);var a=$target.data("indicator"),i=new cdiApp.Modal.Model({app:t,indicatorName:t.flatIndicators[a].label,indicatorDescription:t.flatIndicators[a].description});new cdiApp.Modal.View({model:i,className:"cdi-modal",tagName:"div"})})}else setTimeout(function(){t.loadCountry(e)},1e3)},getRank:function(e,t){if("CDI"===t)return i=originalRanks[e].rank_label.replace("*"," (tie)");var a=this.flatIndicators[t],i=0;for(var n in a.values)if(i++,n===e)break;return i},getTemplate:function(e){var t="";return $.ajax({url:Drupal.settings.basePath+Drupal.settings.cdi2016.pathToModule+"/templates/"+e+".tmpl.html",method:"GET",async:!1}).done(function(e){t=e}),t}});cdiApp.CDI={},cdiApp.CDI.Model=Backbone.Model.extend({initialize:function(e){Backbone.pubSub.on("rankCountries",function(e){this.rankCountries(e)},this),this.indicator=e.indicator,this.countries=e.countries,this.app=e.app,this.rankCountries([])},rankCountries:function(e){if(e[1]?this.isWeighted=e[1]:this.isWeighted=0,"mousemove"!==e[3]&&"touchmove"!==e[3]){this.groupedValues=[];var t,a=1,n=1,s=0,r=!1,o=0,d=[];for(var l in this.indicator.values){var h={};h.country=l,h.value=this.indicator.values[l],d.push(h)}for(d.sort(function(e,t){return t.value-e.value}),j=0;j<d.length;j++)if(i=d[j].country,this.indicator.user_friendly_values[i]=this.indicator.values[i].toFixed(2),this.indicator.values.hasOwnProperty(i)){currentTrimmed=parseFloat(this.indicator.values[i].toFixed(2)),currentTrimmed!=s?(a=n,s=currentTrimmed,r=!1):r=!0,n++,r&&(t.rank_label=o+"*");var u={rank:n,rank_label:a+(r?"*":""),country:this.countries[i],value:this.indicator.values[i],value_label:this.indicator.user_friendly_values[i],index:i};o=a,t=u,this.groupedValues.push(u)}for(this.ranksObj={},i=0;i<this.groupedValues.length;i++)c=this.groupedValues[i].index,this.ranksObj[c]=this.groupedValues[i];!0===e[0]?Backbone.pubSub.trigger("adjustCDI",[e[1],e[2],this.ranksObj,this.originalRanksObj,e[3]]):(this.originalRanksObj=$.extend(!0,{},this.ranksObj),originalRanks=this.originalRanksObj)}else Backbone.pubSub.trigger("adjustCDI",[e[1],e[2],this.ranksObj,this.originalRanksObj,e[3]])}}),cdiApp.CDI.View=Backbone.View.extend({initialize:function(){this.indicator=this.model.indicator,this.countries=this.model.countries,this.app=this.model.app,this.groupedValues=this.model.groupedValues,this.propName="",this.sortAsc=!0,"undefined"!=typeof FB&&FB.init({appId:"445215188878009"})},sortArray:function(e,t){null==e&&(e=!0);var a="country"===t?"country":"value";return"value"===a?function(t,i){return t[a]<i[a]?e?1:-1:t[a]>i[a]?e?-1:1:0}:function(t,i){return t[a]<i[a]?e?-1:1:t[a]>i[a]?e?1:-1:0}},render:function(e,t){this.collapsibleViews={};this.$el.find("tbody").html(""),this.groupedValues.sort(this.sortArray(e,t));for(var a in this.groupedValues)if(this.groupedValues.hasOwnProperty(a)){var i=this.groupedValues[a],n=new cdiApp.infoView({tagName:"tr",className:"info",id:i.index+"-info",countryCode:i.index}),s=new cdiApp.trendView({tagName:"tr",className:"trend",id:i.index+"-trend",countryCode:i.index,app:this.app});this.collapsibleViews[i.index]={info:n,trend:s};$('<div class="chart-holder"></div>');var r=$('<tr tabindex="0" id="'+i.index+'-master" data-v="info" data-c="'+i.index+'" class="master-row"></tr>');r.html('<td><span class="new-value new-rank"></span> <span class="original-value original-rank">'+i.rank_label+'</span></td><td><a class="expand-row" href="#" title="Expand row"><span class="country-label">'+i.country+'</span></a></td><td><div><span class="new-value new-score">'+i.value_label+'</span> <span class="original-value original-score"></span></td><td><div class="chart-holder"></div></td><td class="spacer"></td><td class="facebook-td"><a data-c="'+i.index+'" href="#"></a></td><td class="twitter-td"><a class="twitter-share-row" href="http://twitter.com/intent/tweet?text='+encodeURIComponent(i.country)+"%20ranks%20"+i.rank_label.replace("*","%20(tie)")+"%20of%2027%20on%20the%20Commitment%20to%20Development%20Index&amp;url="+encodeURIComponent(location.href)+'&amp;via=CGDev"></a></td>'),this.$el.find("tbody").append(r);var o=this.indicator.children;this.app.createBarChart(currentYear,i.index,o,r.find(".chart-holder"),!1,this.indicator.min,this.indicator.max,"0",this.indicator.user_friendly_max,1),this.$el.find("tbody").append(n.$el),this.$el.find("tbody").append(s.$el)}this.model.isWeighted&&Backbone.pubSub.trigger("adjustCDI",[1,0,this.model.ranksObj,this.model.originalRanksObj,"resorted"]),$("#home-cdi").addClass("home-processed")},events:{"mouseup .active .bar-segment":"barSegmentClicked","click tr.master-row, .load-trends, .close-info":"showCollapsed","click a.sorting":"sortColumn","click .facebook-td a":"facebookShare","click .twitter-td a":"twitterShare"},barSegmentClicked:function(e){e.preventDefault(),Backbone.pubSub.trigger("triggerNext",e),e.stopImmediatePropagation()},twitterShare:function(e){var t=e.currentTarget.parentNode.parentNode.getAttribute("data-c");dataLayer.push({event:"cdiTweet",label:t+"-overall"})},facebookShare:function(e){e.preventDefault(),e.stopImmediatePropagation();var t=this.model.originalRanksObj[$(e.target).attr("data-c")],a=t.country,i=t.rank_label.replace("*"," (tie)");FB.ui({method:"feed",name:a+" ranks "+i+" out of 27 on the Commitment to Development Index",caption:"The Commitment to Development Index: Ranking the Rich",description:"The Commitment to Development Index ranks 27 of the world's richest countries on their dedication to policies that benefit people living in poorer nations.",link:"https://www.cgdev.org"+location.pathname,picture:"https://www.cgdev.org/sites/default/files/cdi-2017-image-share_final.png"}),$(e.currentTarget).blur(),dataLayer.push({event:"cdiFacebook",label:a+"-overall"})},showCollapsed:function(e){if("twitter-share-row"!==e.target.className){e.preventDefault();var t=$(e.target),a=$(e.currentTarget);if(!t.hasClass("bar-segment")||!t.parent().parent().parent().hasClass("active")){var i=!!a.hasClass("close-bottom-trends"),n=a.attr("data-c"),s=a.attr("data-v");a=a.hasClass("close-info")?$("#"+n+"-master"):a.hasClass("close-component")?$("#home-cdi-indicator ."+n+"-master"):a;var r=this.collapsibleViews[n][s],o=0;if(a.hasClass("active")){if("info"===s){var d=$("#"+n+"-info a.load-trends");d.hasClass("active-trend")&&($targetInfo=a,a=d,viewInfo=r,r=this.collapsibleViews[n].trend,$("#"+n+"-trend .trends-wrapper").addClass("faster-collapse"),o=500,this.collapseTrends(a,r,o,n,i),a=$targetInfo,r=viewInfo),$("#"+n+"-info .info-wrapper").css("height",0),o=500,this.showCollapsedHelper(a,r,o,n)}"trend"===s&&($("#"+n+"-trend .trends-wrapper").css("height",0),o=750,this.collapseTrends(a,r,o,n))}else this.showCollapsedHelper(a,r,o,n)}}},collapseTrends:function(e,t,a,i,n){if($("#"+i+"-trend .trends-wrapper").css("height",0),this.showCollapsedHelper(e,t,a,i),n){var s=e.parent();$("html, body").animate({scrollTop:s.offset().top-$("#main-menu").height()-$("#cdi-mainNav").height()-$("tr#"+i+"-master").height()},500)}},showCollapsedHelper:function(e,t,a,i){window.setTimeout(function(){e.toggleClass("active").toggleClass("active-trend");var a=e.hasClass("active")?"open":"close";"info"===t.className&&dataLayer.push({event:"cdiToggleRow",rowAction:i+"-overall-"+a}),"trend"===t.className&&(dataLayer.push({event:"cdiToggleTrends",rowAction:i+"-"+a}),e.hasClass("active")?(e.addClass("fading"),setTimeout(function(){e.text("Hide trends"),e.removeClass("fading")},250)):(e.addClass("fading"),setTimeout(function(){e.text("Show trends"),e.removeClass("fading")},250))),t.toggle(),$("#"+i+"-trend .trends-wrapper").removeClass("faster-collapse")},a)},show:function(e){this.$el.show(),"CDI"===e&&setTimeout(function(){$("#home-cdi").addClass("home-processed")},200)},hide:function(){this.$el.hide()},sortColumn:function(e){e.preventDefault();var t=$(e.target);this.sortAsc=t.hasClass("asc");var a=t.data("field");$(".sorting").removeClass("asc des"),this.sortAsc?t.addClass("des"):t.addClass("asc"),this.sortAsc=!this.sortAsc,this.render(this.sortAsc,a),$("#unstack-td .unstack-slider").hasClass("off")&&Backbone.pubSub.trigger("wasUnstacked")}}),cdiApp.mainNav={},cdiApp.mainNav.Model=Backbone.Model.extend({initialize:function(e){var t=this,a=e.items;this.items=[];for(var i in cgdCdi.indicatorsOrder)cgdCdi.indicatorsOrder.hasOwnProperty(i)&&t.items.push({code:cgdCdi.indicatorsOrder[i],label:a[cgdCdi.indicatorsOrder[i]],active:!1})},addOverallItem:function(){this.items.unshift({code:"CDI",label:"Overall",active:!0})}}),cdiApp.mainNav.View=Backbone.View.extend({initialize:function(){Backbone.pubSub.on("triggerNext",function(e){this.menuItemClicked(e)},this),Backbone.pubSub.on("barSegClickContinued",function(e){this.menuItemClickedContinued(e)},this),this.render()},render:function(){var e=this;this.model.items.forEach(function(t,a){if(weightToggle=document.createElement("div"),weightToggle.setAttribute("data-indicator",t.code),weightToggle.className="weight-toggle "+t.code+"-bg "+(t.active?"active":""),activeIndicator=document.createElement("div"),activeIndicator.className="active-indicator",weightToggle.appendChild(activeIndicator),nameSpan=document.createElement("span"),nameSpan.innerHTML='<a class="'+(t.active?"active":"")+' selectable" href="#'+t.code+'" data-indicator="'+t.code+'">'+t.label+"</a>",weightToggle.appendChild(nameSpan),"CDI"!==t.code){for(sliderDiv=document.createElement("div"),sliderDiv.className="slider",i=0;i<7;i++)sliderNotch=document.createElement("div"),sliderNotch.className="slider-notches notch-"+i,sliderDiv.appendChild(sliderNotch);e.attachSliderEvents(sliderDiv,a),sliderSelector=document.createElement("button"),sliderSelector.setAttribute("aria-label",t.label+" weight adjuster"),sliderSelector.className="slider-selector",sliderSelectorInner=document.createElement("div"),sliderSelectorInner.className="slider-selector-inner",sliderSelector.appendChild(sliderSelectorInner),sliderDiv.appendChild(sliderSelector),e.attachSelectorEvents(sliderSelector,a),weightToggle.appendChild(sliderDiv)}else{var n=document.createElement("div");n.className="weights-instruct",$(n).attr("aria-hidden",!1),n.innerHTML='Sliders adjust <button aria-label="Move component weights to adjust scores" id="show-weights-note">weights</button>',weightToggle.appendChild(n);var s=document.createElement("div");s.className="reset-weight";var r=document.createElement("a");r.href="javascript:void(0);",$(s).attr("aria-hidden",!0),r.innerHTML="Reset weights",s.appendChild(r),weightToggle.appendChild(s)}e.$el.append(weightToggle)}),this.addMenuCloseButton(),this.addWeightsNote(),$(window).scroll(function(){el=document.getElementById("cdi-mainNav");var e=$("body").width()>739?31:$("body").width()>739?36:$("body").width()>539?58:35,t=$("#section-header").height()+$(".cdi-header-wrapper").height()+e;if($(document).scrollTop()>=t){var a=$("#cdi-mainNav").height()+20;$(el).addClass("stick-to-top"),$("#new_cdi").css("padding-top",a)}else $(el).removeClass("stick-to-top"),$("#new_cdi").css("padding-top","")})},addMenuCloseButton:function(){this.$el.append('<button id="close-mainNav">(X) Close</button>')},addWeightsNote:function(){this.$el.append('<div id="weights-note"><span>Custom weights X</span><div class="slider"><div class="notch-key notch-even notch-0">1/4</div><div class="notch-key notch-odd notch-1">1/3</div><div class="notch-key notch-even notch-2">1/2</div><div class="notch-key notch-odd notch-3">1</div><div class="notch-key notch-even notch-4">2</div><div class="notch-key notch-odd notch-5">3</div><div class="notch-key notch-even notch-6">4</div><div class="slider-notches even notch-0"></div><div class="slider-notches odd notch-1"></div><div class="slider-notches even notch-2"></div><div class="slider-notches odd notch-3"></div><div class="slider-notches even notch-4"></div><div class="slider-notches odd notch-5"></div><div class="slider-notches even notch-6"></div></div></div>')},attachSliderEvents:function(e,t){var a=this,i=t-1;$(e).click(function(e){sliderSelector=$(".slider .slider-selector").eq(i),sliderSelector.addClass("active-selector jump-selector"),sliderPosition=$(this).offset(),position=a.getXOffset(e),newPosition=position-sliderPosition.left-18,a.limitPosition(),e.data={},e.data.that=a,e.data.ev=e,e.data.i=i,a.selectorStop(e)})},attachSelectorEvents:function(e,t){var a=this,i=t-1;$(e).on("mousedown touchstart",null,i,function(e){e.stopPropagation(),e.preventDefault(),e.xStartOffset=a.getXOffset(e),e.startPosition=$(this).position(),a.selectorStart(e)}),$(e).on("keyup",null,i,function(e){a.keyedWeight(e)})},keyedWeight:function(e){37!==e.keyCode&&39!==e.keyCode||(37===e.keyCode?newPosition=e.currentTarget.offsetLeft-13.6666<-7?-8:parseFloat($(e.currentTarget).css("left"))-13.6666:39===e.keyCode&&(newPosition=e.currentTarget.offsetLeft+13.6666>73?74:parseFloat($(e.currentTarget).css("left"))+13.6666),$(e.currentTarget).css("left",Math.round(3*newPosition)/3),e.data={ev:{currentTarget:e.currentTarget},i:$(e.currentTarget).parent().parent().attr("data-indicator")},this.selectorStop(e))},selectorStart:function(e){sliderIndex=e.data,$(e.currentTarget).addClass("active-selector"),$("body").on("mousemove touchmove",null,{i:sliderIndex,ev:e,that:this},this.selectorMove),$("body").on("mouseup touchend",null,{i:sliderIndex,ev:e,that:this},this.selectorStop)},selectorMove:function(e){e.preventDefault(),xCurrentOffset=e.data.that.getXOffset(e),xDistance=xCurrentOffset-e.data.ev.xStartOffset,newPosition=e.data.ev.startPosition.left+xDistance,e.data.that.limitPosition(),sliderSelector=$(".slider .slider-selector").eq(e.data.i),sliderSelector.css("left",newPosition),e.data.notch=(newPosition+8)/13.6666-3,e.data.transition=0,Backbone.pubSub.trigger("userInput",e)},limitPosition:function(){newPosition<-8?newPosition=-8:newPosition>76&&(newPosition=76)},selectorStop:function(e){if("resetWeight"!==e){delay="slider"===e.data.ev.currentTarget.className?500:0,window.setTimeout(function(){$(".slider .slider-selector").removeClass("active-selector jump-selector")},delay),roundedPosition=13.6666*Math.round((newPosition+8)/13.6666),e.data.notch=Math.round((newPosition+8)/13.6666)-3;var t=e.data.ev.currentTarget;0!==e.data.notch?(eParent=$(t).parents(".weight-toggle"),$(eParent).addClass("weighted"),$(".reset-weight").css("display","inline"),window.setTimeout(function(){$("#cdi-mainNav").addClass("weighted-component")},400)):(eParent=$(t).parents(".weight-toggle"),$(eParent).removeClass("weighted"),$(".reset-weight").css("display","inline")),e.data.transition=1,"keyup"!==e.type&&(roundedPosition=roundedPosition<0?0:roundedPosition,sliderSelector.css("left",roundedPosition-8),$("body").off("mouseup touchend",e.data.that.selectorStop),$("body").off("mousemove touchmove",e.data.that.selectorMove)),window.setTimeout(function(){Backbone.pubSub.trigger("userInput",e)},400)}else window.setTimeout(function(){Backbone.pubSub.trigger("userInput",e)},400)},resetWeight:function(){$(".slider .slider-selector").addClass("jump-selector"),$(".slider .slider-selector").css("left","33px"),$(".weight-toggle").removeClass("weighted"),$("#cdi-mainNav").removeClass("weighted-component"),window.setTimeout(function(){$(".slider .slider-selector").removeClass("jump-selector")},400),$(".reset-weight").attr("aria-hidden",!0),e="resetWeight",this.selectorStop(e)},getXOffset:function(e){return"touchstart"===e.type||"touchmove"===e.type?e.originalEvent.touches[0].pageX:"mousedown"===e.type||"mousemove"===e.type||"click"===e.type?e.pageX:void 0},events:{"click a.selectable":"menuItemClicked","click .reset-weight a":"resetWeight","click #close-mainNav":"closeMainNav","mouseover #show-weights-note":"toggleWeightsNote","mouseout #show-weights-note":"toggleWeightsNote","click #show-weights-note":"toggleWeightsNote"},toggleWeightsNote:function(e){"click"===e.type&&0!==e.screenX||("mouseout"!==e.type?"mouseover"!==e.type&&$("#weights-note").hasClass("show-note")?this.hideWeightsNote():this.showWeightsNote():this.hideWeightsNote())},showWeightsNote:function(){$("#weights-note").css("visibility","visible"),$("#weights-note").addClass("show-note")},hideWeightsNote:function(){$("#weights-note").removeClass("show-note"),window.setTimeout(function(){$("#weights-note").css("visibility","hidden")},500)},closeMainNav:function(){var e=$("#cdi-mainNav").hasClass("closed")?"(X) Close":"Open menu";$("#cdi-mainNav").toggleClass("closed"),$("#close-mainNav").text(e),this.hideWeightsNote()},menuItemClickedContinued:function(e,t){that=this;var a=$(e.target),i=null;if(a.hasClass("cdi-next-button")&&(a=$("div."+a.attr("data-indicator")+"-bg a.selectable")),a.hasClass("bar-segment")&&(i=a.parent().parent().parent().attr("data-c"),a=$("div."+a[0].className.match(/CDI_\w{3}/)+"-bg a.selectable"),t="CDI"),a.hasClass("return-to-main")&&(i=a.attr("data-c"),returnMain=!0,a=$("div.CDI-bg a.selectable")),a.parent().parent().addClass("active"),this.toggleSliders(a.attr("data-indicator")),"CDI"===a.attr("data-indicator"))$("#indicator-description-wrapper").removeClass("idw-processed"),setTimeout(function(){$(".indicator-description, .indicator-explanation").empty(),cgdCdi.hideIndicator(t),cgdCdi.reload(a.attr("data-indicator"),i),$(".cdi-next-button").text("Next up: "+cgdCdi.indicators[cgdCdi.indicatorsOrder[0]]).attr("data-indicator","CDI_AID"),$("#indicator-description-wrapper").addClass("idw-processed home")},500);else{cgdCdi.hideIndicator(t),$("#indicator-description-wrapper").removeClass("home"),cgdCdi.reload(a.attr("data-indicator"),i);var n=cgdCdi.indicatorsOrder.indexOf(a.attr("data-indicator"));if($(".cdi-next-button").css("opacity",0),n<cgdCdi.indicatorsOrder.length-1){var s=n+1,r=cgdCdi.indicators[cgdCdi.indicatorsOrder[s]];setTimeout(function(){$(".cdi-next-button").text("Next up: "+r).attr("data-indicator",cgdCdi.indicatorsOrder[s]),$(".cdi-next-button").css("opacity",1)},500)}else setTimeout(function(){$(".cdi-next-button").text("Next up: Overall scores").attr("data-indicator","CDI"),$(".cdi-next-button").css("opacity",1)},500)}var o=$("body").width()>720?50:70,d=$("#section-header").height()+$(".cdi-header-wrapper").height()+o;$("#cdi-mainNav").hasClass("stick-to-top")&&null==i&&$("body").animate({scrollTop:d},200)},menuItemClicked:function(e){if(e.preventDefault(),!$(e.currentTarget).parent().parent().hasClass("active")){$(".show-return").removeClass("show-return");var t=this.$el.find("div.active");t.removeClass("active");var a=t.data("indicator");if("CDI"===a){if($("#indicator-description-wrapper").removeClass("idw-processed"),$("#home-cdi").removeClass("home-processed"),that=this,"mouseup"===e.type)return void setTimeout(function(){Backbone.pubSub.trigger("barSegClickContinued",e)},500);setTimeout(function(){that.menuItemClickedContinued(e,a)},500)}else this.menuItemClickedContinued(e,a)}},toggleSliders:function(e){"CDI"!==e?($(".slider").addClass("hide-slider"),window.setTimeout(function(){$(".slider").css("display","none")},500)):$(".unstack-slider").hasClass("off")||($(".slider").css("display","block"),window.setTimeout(function(){$(".slider").removeClass("hide-slider")},100))}}),cdiApp.collapsibleView=Backbone.View.extend({loaded:!1,toggle:function(e){this.$el.fadeToggle(0);var t=!!e;this.render(t)},hide:function(){this.$el.hide()},show:function(){this.loaded||this.render(),this.$el.show()}}),cdiApp.infoView=cdiApp.collapsibleView.extend({initialize:function(e){this.countryCode=e.countryCode},render:function(){that=this;var e=window.innerWidth<=410?42:81;if(this.loaded)cHeight=$("#"+that.countryCode+"-info .field-name-field-overall").height()+$("#"+that.countryCode+"-info .year-results").height()+e,$("#"+that.countryCode+"-info .info-wrapper").css("height",cHeight);else{this.loaded=!0;var t='<td colspan="7" class="info-td"><div class="info-wrapper"><div class="field field-name-field-overall field-type-text-long field-label-above"><div class="field-label">Overall:&nbsp;</div><div class="field-items"><div class="'+that.countryCode+'-summary-text" class="field-item even">Loading ... <br /> <br> </div></div></div><div class="year-results"><a class="cdi-country-report" href="/cdi-2017/country/'+that.countryCode+'" target="_blank">Country report</a></div><a data-c="'+that.countryCode+'" data-v="info" class="close-info active" href="#">(X) Close</a></div></td>';that.$el.append(t),$.get("/cdi-2017/country/"+that.countryCode,function(t){$("."+that.countryCode+"-summary-text").text($(t).find(".indicator.cdi .left-side").text()),cHeight=$("#"+that.countryCode+"-info .field-name-field-overall").height()+$("#"+that.countryCode+"-info .year-results").height()+e,$("#"+that.countryCode+"-info .info-wrapper").css("height",cHeight)}),cHeight=$("#"+that.countryCode+"-info .field-name-field-overall").height()+$("#"+that.countryCode+"-info .year-results").height()+e,$("#"+that.countryCode+"-info .year-results").before('<a class="load-trends" data-v="trend" data-c="'+that.countryCode+'" href="#">Show trends</a>'),$("#"+that.countryCode+"-info .info-wrapper").css("height",cHeight),$("#"+that.countryCode+"-info .year-results a").text("Country report").attr("target","_blank")}}}),cdiApp.trendView=cdiApp.collapsibleView.extend({initialize:function(e){this.countryCode=e.countryCode,this.app=e.app},render:function(){if(this.loaded){r=$("#"+this.countryCode+"-trend .trends-inner-wrapper").height()+50;$("#"+this.countryCode+"-trend .trends-wrapper").css("height",r)}else{this.loaded=!0;var e=$('<div class="trends-inner-wrapper"></div>'),t=$('<div class="trends-wrapper"></div>'),a=$('<td colspan="7"></td>'),i=this;t.append(e),a.append(t),this.$el.append(a);var n=["CDI"].concat(this.app.indicatorsOrder);i.app.indicators.CDI="Overall",n.forEach(function(t){var a=[],n=$("<canvas></canvas>"),s=$('<div class="line-chart-wrapper '+t+'"></div>'),r=i.app.indicators[t],o=i.app.flatIndicators[t].values[i.countryCode];s.append('<div class="line-chart-header '+t+'"><span class="indicator-label">'+r+'</span> <span class="indicator-value">'+o.toFixed(1)+"</span></div>"),s.append(n),e.append(s);for(var d in i.app.flatIndicators[t].trends[i.countryCode])a.push({year:d,data:i.app.flatIndicators[t].trends[i.countryCode][d]});var l=new cdiApp.LineChart.Model({data:a,indicator:t});new cdiApp.LineChart.View({model:l,el:n})});var s=$('<div style="clear:left">');s.append('<div class="year-results hello"><a class="cdi-country-report" target="_blank" href="/cdi-2017/country/'+this.countryCode+'">Country report</a></div>'),e.append(s),e.append('<a data-c="'+this.countryCode+'" data-v="info" class="close-info close-bottom-trends active" href="#">(X) Close</a>');var r=$("#"+this.countryCode+"-trend .trends-inner-wrapper").height()+80;$("#"+this.countryCode+"-trend .trends-wrapper").css("height",r)}}}),cdiApp.LineChart={},cdiApp.LineChart.Model=Backbone.Model.extend({initialize:function(e){var t=cgdCdi.indicatorColors[e.indicator],a=t.border,i=t.background;this.data={labels:[],datasets:[{data:[],fillColor:"rgba(0,0,0,0)",pointStrokeCol:a,strokeColor:a,pointColor:a}]};var n=this;e.data.forEach(function(e){n.data.labels.push(e.year),n.data.datasets[0].data.push(parseFloat(e.data).toFixed(2))}),this.options={scaleOverride:!0,scaleSteps:6,scaleStepWidth:2,scaleStartValue:0,scaleShowGridLines:!1,tooltipTemplate:"<%= value %>",tooltipFillColor:i,tooltipFontColor:"#706E69",tooltipXPadding:10,scaleLineColor:"rgba(0,0,0,.1)",scaleFontColor:"#666",pointDotRadius:2,percentageInnerCutout:70,pointHitDetectionRadius:4}}}),cdiApp.LineChart.View=Backbone.View.extend({initialize:function(){this.data=this.model.data,this.options=this.model.options,this.render()},render:function(){var e=this.el.getContext("2d");new Chart(e).Line(this.data,this.options)}}),cdiApp.CDI_Indicator={},cdiApp.CDI_Indicator.Model=Backbone.Model.extend({initialize:function(e){this.app=e.app,this.data=e.data,this.indicator=e.indicator,this.indicators=this.app.flatIndicators[this.indicator].children,this.groupedValues=[];var t=1;for(var a in this.data.values)this.data.values.hasOwnProperty(a)&&(this.groupedValues.push({rank:t,country:this.app.countries[a],value:this.data.values[a],value_label:this.data.user_friendly_values[a],id:a,min:this.data.min,min_label:this.data.user_friendly_min,max:this.data.max,max_label:this.data.user_friendly_max}),t++)}}),cdiApp.CDI_Indicator.View=Backbone.View.extend({initialize:function(){this.data=this.model.data,this.indicator=this.model.indicator,this.app=this.model.app,this.indicators=this.model.indicators,this.groupedValues=this.model.groupedValues},render:function(){var e=this,t=this.indicators;this.$el.find("tbody").empty(),this.el.className=this.indicator,this.collapsibleViews={},$("#indicator-description-wrapper").removeClass("idw-processed");for(var a in this.groupedValues)if(this.groupedValues.hasOwnProperty(a)){var i=this.groupedValues[a],n=i.id,s=new cdiApp.Components.Model({countryCode:n,indicators:t,app:this.app}),r=new cdiApp.Components.View({tagName:"tr",className:"components "+n+"-components",model:s});this.collapsibleViews[n]={components:r};$('<div class="chart-holder"></div>');var o=$('<tr class="'+n+'-master master-row" data-c="'+n+'"></tr>');o.html("<td>"+i.rank+'</td><td><a href="#"><span class="country-label">'+i.country+"</a></span></td><td>"+i.value_label+'</td><td><div class="chart-holder"></div></td><td class="spacer"></td><td class="facebook-td"><a data-country="'+i.country+'" data-rank="'+i.rank+'" data-component="'+this.app.indicators[this.indicator]+'" href="#"></a></td><td class="twitter-td"><a class="twitter-share-row" href="http://twitter.com/intent/tweet?text='+i.country+"%20ranks%20"+i.rank+"%20of%2027%20on%20the%20"+this.app.indicators[this.indicator].toLowerCase()+"%20component%20of%20the%20Commitment%20to%20Development%20Index&amp;url="+encodeURIComponent(location.href)+'&amp;via=CGDev"></a></td>'),this.$el.find("tbody").append(o),this.app.createBarChart(currentYear,n,[this.indicator],o.find(".chart-holder"),!1,i.min,i.max,i.min_label,i.max_label,2),this.$el.find("tbody").append(r.$el),setTimeout(function(){$("#indicator-description").empty(),$("#indicator-description").append('<div class="indicator-description">'+e.model.data.description+"</div>"),$("#indicator-explanation").empty(),$("#indicator-explanation").append('<div class="indicator-description">'+e.model.data.explanation+"</div>"),$("#indicator-description-wrapper").addClass("idw-processed")},500)}},events:{"click tr.master-row, .close-components":"showComponents","click a.sorting":"sortColumn","click .facebook-td a":"facebookShare","click .twitter-td a":"twitterShare","click .return-to-main":"returnToMain"},returnToMain:function(e){e.preventDefault(),dataLayer.push({event:"cdiReturnMain",from:e.target.dataset.c+"-"+$("#home-cdi-indicator").attr("class")}),Backbone.pubSub.trigger("triggerNext",e)},twitterShare:function(e){var t=e.currentTarget.parentNode.parentNode.getAttribute("data-c");dataLayer.push({event:"cdiTweet",label:t+"-"+e.delegateTarget.className})},facebookShare:function(e){e.preventDefault(),e.stopImmediatePropagation(),FB.ui({method:"feed",name:e.currentTarget.dataset.country+" ranks "+e.currentTarget.dataset.rank+" out of 27 on "+e.currentTarget.dataset.component.toLowerCase()+" in the Commitment to Development Index",caption:"The Commitment to Development Index: Ranking the Rich",description:"The Commitment to Development Index ranks 27 of the world's richest countries on their dedication to policies that benefit people living in poorer nations.",link:"https://www.cgdev.org"+location.pathname,picture:"https://www.cgdev.org/sites/default/files/cdi-2017-image-share_final.png"}),dataLayer.push({event:"cdiFacebook",label:e.currentTarget.dataset.country+"-"+e.currentTarget.dataset.component.toLowerCase()}),$(e.currentTarget).blur()},showComponents:function(e){if(!e.target||"twitter-share-row"!==e.target.className){$target=$(e.currentTarget);var t=!!$target.hasClass("close-bottom"),a=$target.attr("data-c"),i=this.collapsibleViews[a].components;$target=$target.hasClass("close-components")?$("."+a+"-master"):$target,delay=0,$target.hasClass("active")&&($("."+a+"-components .components-wrapper").height(0),t&&this.scrollToTarget($target),delay=500);var n=$target.hasClass("active")?"close":"open",s=e.barSegment?"-direct":"";dataLayer.push({event:"cdiToggleRow",rowAction:a+"-"+$("#home-cdi-indicator").attr("class")+"-"+n+s}),setTimeout(function(){$target.toggleClass("active"),i.toggle(e.barSegment)},delay),e.barSegment?this.scrollToTarget($target,10):e.preventDefault()}},scrollToTarget:function(e,t){var a=null!=t?t:0;$("html, body").animate({scrollTop:e.offset().top-$("#main-menu").height()-$("#cdi-mainNav").height()-a},500)},show:function(e){if(this.$el.show(),null!=e){var t={};t.currentTarget=$("tr."+e+"-master.master-row"),t.barSegment=!0,this.showComponents(t)}},hide:function(){this.$el.hide()},sortColumn:function(e){e.preventDefault();var t=$(e.target),a=t.hasClass("asc"),i=t.data("field");a?t.removeClass("asc"):t.addClass("asc"),a=!a,this.sortByField(i,a)},sortByField:function(e,t){this.groupedValues.sort(this.sortArray(e,t)),this.render()},sortArray:function(e,t){return function(a,i){return a[e]<i[e]?t?-1:1:a[e]>i[e]?t?1:-1:0}}}),cdiApp.Components={},cdiApp.Components.Model=Backbone.Model.extend({initialize:function(e){this.app=e.app,this.countryCode=e.countryCode,this.data=this.app.getIndicatorsLabels(e.indicators)}}),cdiApp.Components.View=cdiApp.collapsibleView.extend({initialize:function(){this.countryCode=this.model.countryCode,this.indicator=this.model.indicator,this.data=this.model.data,this.app=this.model.app},render:function(e){if(!this.loaded){$(".show-return").removeClass("show-return"),this.loaded=!0;var t=$('<td colspan="7"></td>'),a=$('<div class="components-wrapper"></div>');e&&a.addClass("show-return");var i=$('<div class="components-inner-wrapper"></div>');a.append(i),t.append(a),this.$el.append(t),i.append('<div class="year-results"><a class="cdi-country-report" target="_blank" href="/cdi-2017/country/'+this.countryCode+'">Country report</a></div>','<a data-c="'+this.countryCode+'" data-v="components" class="close-components active" href="#">(X) Close</a>','<a data-c="'+this.countryCode+'" data-v="components" class="return-to-main active" href="#">(←) Go back</a><br /><span class="context-key"><div class="context-div key"></div> = other countries’ scores</span>');for(var n in this.data){var s=[],r=this.app.flatIndicators[n];if(this.app.flatIndicators[n].children){l=$('<div class="indicator-label category '+this.app.flatIndicators[n].parent+'">'+this.data[n]+"</div>"),i.append(l);for(var o in this.app.flatIndicators[n].children){d=null!==this.app.flatIndicators[this.app.flatIndicators[n].children[o]].unit?this.app.flatIndicators[this.app.flatIndicators[n].children[o]].unit:"",s=[this.app.flatIndicators[n].children[o]],l=$('<div class="indicator-label">'+this.app.flatIndicators[this.app.flatIndicators[n].children[o]].label+' <a href="#info" class="indicator-info" data-indicator="'+this.app.flatIndicators[n].children[o]+'">?</a><br /><span class="indicator-units">'+d+"</span></div>"),c=$('<div class="chart-holder"></div>'),i.append(l),i.append(c),r=this.app.flatIndicators[this.app.flatIndicators[n].children[o]],isNaN(r.user_friendly_values[this.countryCode].replace(/%|\$|,/,""))&&c.addClass("null-value"),r.less_is_better&&c.addClass("less-is-better"),this.app.createBarChart(currentYear,this.countryCode,s,c,!0,r.min,r.max,r.user_friendly_min,r.user_friendly_max,4),this.app.addContext(currentYear,s,c,this.countryCode)}}else{var d;d=null!==this.app.flatIndicators[n].unit?this.app.flatIndicators[n].unit:"",s=[n];var l=$('<div class="indicator-label no-child category '+this.app.flatIndicators[n].parent+'">'+this.data[n]+' <a href="#info" class="indicator-info" data-indicator="'+n+'">?</a><br /><span class="indicator-units">'+d+"</span></div>"),c=$('<div class="chart-holder"></div>');i.append(l),i.append(c),this.app.createBarChart(currentYear,this.countryCode,s,c,!0,r.min,r.max,r.user_friendly_min,r.user_friendly_max,3),this.app.addContext(currentYear,s,c,this.countryCode)}}i.append('<div class="year-results"><a class="components-report-bottom cdi-country-report" target="_blank" href="/cdi-2017/country/'+this.countryCode+'">Country report</a></div>','<a data-c="'+this.countryCode+'" data-v="components" class="close-components close-bottom active" href="#">(X) Close</a>','<a data-c="'+this.countryCode+'" data-v="components" class="return-to-main close-bottom active" href="#">(←) Go back</a>')}var h=$("."+this.countryCode+"-components .components-inner-wrapper").height()+50;$("."+this.countryCode+"-components .components-wrapper").height(h)},events:{"click a.indicator-info":"showIndicatorInfo"},showIndicatorInfo:function(e){$target=$(e.target);var t=$target.data("indicator"),a=new cdiApp.Modal.Model({app:this.app,indicatorName:this.app.flatIndicators[t].label,indicatorDescription:this.app.flatIndicators[t].description});new cdiApp.Modal.View({model:a,className:"cdi-modal",tagName:"div"});e.preventDefault()}});